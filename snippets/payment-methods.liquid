{%- comment -%}
  支付方式选择组件
  支持多种支付方式的展示和选择
{%- endcomment -%}

<div class="payment-methods" data-payment-methods>
  {% assign available_gateways = checkout.payment_gateways %}

  {% if available_gateways.size > 0 %}
    <div class="payment-gateways">
      {% for gateway in available_gateways %}
        <div class="payment-method {% if gateway == checkout.payment_gateway %}selected{% endif %}"
             data-payment-gateway="{{ gateway.id }}"
             data-gateway-name="{{ gateway.name }}">

          <input type="radio"
                 name="payment_gateway"
                 value="{{ gateway.id }}"
                 id="payment_gateway_{{ gateway.id }}"
                 {% if gateway == checkout.payment_gateway %}checked{% endif %}
                 class="payment-gateway-radio">

          <label class="payment-method-label" for="payment_gateway_{{ gateway.id }}">
            <div class="payment-method-info">
              <div class="payment-method-name">
                {{ gateway.name }}
                {% if gateway.preferred? %}
                  <span class="payment-badge recommended">推荐</span>
                {% endif %}
              </div>
              <div class="payment-method-details">
                {% if gateway.description %}
                  {{ gateway.description }}
                {% else %}
                  安全便捷的支付方式
                {% endif %}
              </div>

              <!-- 显示费用信息 -->
              {% if gateway.additional_fee > 0 %}
                <div class="payment-method-fee">
                  手续费: {{ gateway.additional_fee | money }}
                </div>
              {% endif %}
            </div>

            <!-- 支付图标 -->
            <div class="payment-method-icons">
              {% assign gateway_icons = gateway.name | payment_gateway_icons %}
              {% for icon in gateway_icons %}
                <img src="{{ icon | asset_url }}"
                     alt="{{ icon | split: '/' | last | split: '.' | first }}"
                     class="payment-icon"
                     loading="lazy">
              {% endfor %}
            </div>
          </label>

          <!-- 支付详情区域 -->
          <div class="payment-method-details-content {% if gateway == checkout.payment_gateway %}expanded{% endif %}">
            {% if gateway.name contains '信用卡' or gateway.name contains 'Credit' %}
              {% render 'payment-form-credit-card', gateway: gateway %}
            {% elsif gateway.name contains '支付宝' or gateway.name contains 'Alipay' %}
              {% render 'payment-form-alipay', gateway: gateway %}
            {% elsif gateway.name contains '微信' or gateway.name contains 'WeChat' %}
              {% render 'payment-form-wechat', gateway: gateway %}
            {% elsif gateway.name contains 'PayPal' %}
              {% render 'payment-form-paypal', gateway: gateway %}
            {% elsif gateway.name contains 'Apple' %}
              {% render 'payment-form-apple-pay', gateway: gateway %}
            {% elsif gateway.name contains 'Google' %}
              {% render 'payment-form-google-pay', gateway: gateway %}
            {% else %}
              {% render 'payment-form-generic', gateway: gateway %}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- 分期付款选项 -->
  {% assign cart_total = cart.total_price %}
  {% if cart_total >= 1000 %}
    <div class="installment-options">
      <h3 class="installment-title">分期付款选项</h3>
      <div class="installment-providers">
        {% render 'installment-provider', provider: '花呗分期', cart_total: cart_total %}
        {% render 'installment-provider', provider: '京东白条', cart_total: cart_total %}
        {% render 'installment-provider', provider: '信用卡分期', cart_total: cart_total %}
      </div>
    </div>
  {% endif %}

  <!-- 先买后付选项 -->
  {% if cart_total >= 200 and cart_total <= 5000 %}
    <div class="bnpl-options">
      <h3 class="bnpl-title">先买后付选项</h3>
      <div class="bnpl-providers">
        {% render 'bnpl-provider', provider: 'Klarna', cart_total: cart_total %}
        {% render 'bnpl-provider', provider: 'Afterpay', cart_total: cart_total %}
        {% render 'bnpl-provider', provider: 'Affirm', cart_total: cart_total %}
      </div>
    </div>
  {% endif %}

  <!-- 加密货币支付 -->
  {% if settings.enable_crypto_payments %}
    <div class="crypto-payment-options">
      <h3 class="crypto-title">加密货币支付</h3>
      <div class="crypto-providers">
        {% render 'crypto-provider', provider: 'Bitcoin', cart_total: cart_total %}
        {% render 'crypto-provider', provider: 'Ethereum', cart_total: cart_total %}
        {% render 'crypto-provider', provider: 'USDT', cart_total: cart_total %}
      </div>
    </div>
  {% endif %}
</div>

<style>
  .payment-methods {
    margin-bottom: var(--spacing-6);
  }

  .payment-gateways {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
    margin-bottom: var(--spacing-6);
  }

  .payment-method {
    background: var(--checkout-bg-primary);
    border: 2px solid var(--checkout-border);
    border-radius: var(--checkout-radius);
    overflow: hidden;
    transition: all var(--duration-normal) var(--ease-sci-fi);
  }

  .payment-method:hover {
    border-color: var(--checkout-primary);
    box-shadow: 0 4px 12px rgba(135, 206, 235, 0.1);
  }

  .payment-method.selected {
    border-color: var(--checkout-primary);
    background: rgba(135, 206, 235, 0.05);
  }

  .payment-gateway-radio {
    display: none;
  }

  .payment-method-label {
    display: flex;
    align-items: center;
    padding: var(--spacing-4);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-sci-fi);
  }

  .payment-method-info {
    flex: 1;
    margin-right: var(--spacing-3);
  }

  .payment-method-name {
    font-weight: var(--font-weight-semibold);
    color: var(--checkout-text-primary);
    margin-bottom: var(--spacing-1);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  .payment-badge.recommended {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    background: var(--checkout-success);
    color: white;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }

  .payment-method-details {
    font-size: var(--font-size-sm);
    color: var(--checkout-text-secondary);
    line-height: var(--line-height-relaxed);
  }

  .payment-method-fee {
    font-size: var(--font-size-xs);
    color: var(--checkout-text-secondary);
    margin-top: var(--spacing-1);
  }

  .payment-method-icons {
    display: flex;
    gap: var(--spacing-2);
    align-items: center;
  }

  .payment-icon {
    width: 32px;
    height: 20px;
    object-fit: contain;
    opacity: 0.8;
    transition: opacity var(--duration-normal);
  }

  .payment-method.selected .payment-icon {
    opacity: 1;
  }

  .payment-method-details-content {
    border-top: 1px solid var(--checkout-border-light);
    background: var(--checkout-bg-tertiary);
    max-height: 0;
    overflow: hidden;
    transition: max-height var(--duration-normal) var(--ease-sci-fi);
  }

  .payment-method-details-content.expanded {
    max-height: 500px;
  }

  .installment-options,
  .bnpl-options,
  .crypto-payment-options {
    background: var(--checkout-bg-secondary);
    border: 1px solid var(--checkout-border);
    border-radius: var(--checkout-radius);
    padding: var(--spacing-4);
    margin-bottom: var(--spacing-4);
  }

  .installment-title,
  .bnpl-title,
  .crypto-title {
    font-family: var(--font-heading-family);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--checkout-text-primary);
    margin: 0 0 var(--spacing-3) 0;
  }

  .installment-providers,
  .bnpl-providers,
  .crypto-providers {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-3);
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .payment-method-label {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-2);
    }

    .payment-method-info {
      margin-right: 0;
    }

    .payment-method-icons {
      align-self: flex-end;
    }

    .installment-providers,
    .bnpl-providers,
    .crypto-providers {
      grid-template-columns: 1fr;
    }
  }

  /* 加载状态 */
  .payment-method.loading {
    opacity: 0.6;
    pointer-events: none;
  }

  .payment-method.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--checkout-primary), var(--checkout-success));
    animation: loading-bar 1.5s ease-in-out infinite;
  }

  @keyframes loading-bar {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  /* 错误状态 */
  .payment-method.error {
    border-color: var(--checkout-error);
    background: rgba(220, 53, 69, 0.05);
  }

  .payment-error-message {
    padding: var(--spacing-3);
    background: rgba(220, 53, 69, 0.1);
    color: var(--checkout-error);
    font-size: var(--font-size-sm);
    border-radius: var(--checkout-radius);
    margin-top: var(--spacing-2);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const paymentMethods = document.querySelectorAll('.payment-method');

    paymentMethods.forEach(method => {
      const radio = method.querySelector('.payment-gateway-radio');
      const details = method.querySelector('.payment-method-details-content');

      method.addEventListener('click', function(e) {
        // 如果点击的是输入框或其他交互元素，不触发选择
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'A') {
          return;
        }

        selectPaymentMethod(method);
      });

      radio.addEventListener('change', function() {
        if (radio.checked) {
          selectPaymentMethod(method);
        }
      });
    });

    function selectPaymentMethod(method) {
      // 移除其他选中状态
      paymentMethods.forEach(m => {
        m.classList.remove('selected');
        const details = m.querySelector('.payment-method-details-content');
        if (details) {
          details.classList.remove('expanded');
        }
      });

      // 添加选中状态
      method.classList.add('selected');
      const details = method.querySelector('.payment-method-details-content');
      if (details) {
        details.classList.add('expanded');
      }

      // 更新隐藏的radio按钮
      const radio = method.querySelector('.payment-gateway-radio');
      if (radio) {
        radio.checked = true;
      }

      // 触发自定义事件
      const event = new CustomEvent('paymentMethodSelected', {
        detail: {
          gatewayId: method.dataset.gatewayId,
          gatewayName: method.dataset.gatewayName
        }
      });
      document.dispatchEvent(event);
    }

    // 监听支付方式选择事件
    document.addEventListener('paymentMethodSelected', function(e) {
      // 可以在这里添加分析跟踪
      if (typeof gtag !== 'undefined') {
        gtag('event', 'payment_method_selected', {
          payment_gateway: e.detail.gatewayName
        });
      }
    });
  });
</script>