{% comment %}
  增强的SEO元标签组件
  包含完整的SEO优化、Open Graph、Twitter Card等结构化数据
{% endcomment %}

{%- assign og_title = page_title | default: shop.name -%}
{%- assign og_url = canonical_url -%}
{%- assign og_type = 'website' -%}
{%- assign og_description = page_description | default: shop.description | default: shop.name -%}
{%- assign og_image = '' -%}

{%- comment -%}
  根据页面类型设置不同的Open Graph参数
{%- endcomment -%}
{%- case template -%}
  {%- when 'product' -%}
    {%- assign og_type = 'product' -%}
    {%- capture og_image -%}
      {{ product.featured_image | image_url: width: 1200, height: 630, crop: 'center' }}
    {%- endcapture -%}
    {%- assign og_description = product.description | strip_html | strip | truncate: 160 -%}

  {%- when 'article' -%}
    {%- assign og_type = 'article' -%}
    {%- capture og_image -%}
      {{ article.image | image_url: width: 1200, height: 630, crop: 'center' }}
    {%- endcapture -%}
    {%- assign og_description = article.excerpt | strip_html | strip | default: article.content | strip_html | strip | truncate: 160 -%}

  {%- when 'collection' -%}
    {%- capture og_image -%}
      {{ collection.featured_image | image_url: width: 1200, height: 630, crop: 'center' }}
    {%- endcapture -%}
    {%- assign og_description = collection.description | strip_html | strip | truncate: 160 -%}

  {%- when 'blog' -%}
    {%- assign og_type = 'blog' -%}
    {%- capture og_image -%}
      {{ blog.articles.first.image | image_url: width: 1200, height: 630, crop: 'center' }}
    {%- endcapture -%}
    {%- assign og_description = blog.description | strip_html | strip | truncate: 160 -%}

  {%- when 'page' -%}
    {%- capture og_image -%}
      {{ page_content | strip_html | split: 'src="' | last | split: '"' | first }}
    {%- endcapture -%}
{%- endcase -%}

{%- if og_image == blank -%}
  {%- capture og_image -%}
    {{ settings.logo | image_url: width: 1200, height: 630, crop: 'center' }}
  {%- endcapture -%}
{%- endif -%}

<!-- 基础SEO元标签 -->
{%- if page_title -%}
  {%- if current_page != 1 -%}
    <title>{{ page_title }} - 第{{ current_page }}页 - {{ shop.name }}</title>
  {%- else -%}
    <title>{{ page_title }} - {{ shop.name }}</title>
  {%- endif -%}
{%- else -%}
  <title>{{ shop.name }}</title>
{%- endif -%}

{%- if page_description -%}
  <meta name="description" content="{{ page_description | escape }}">
{%- endif -%}

<!-- 关键词标签 -->
{%- if template == 'product' -%}
  <meta name="keywords" content="{{ product.title | escape }}, {{ product.type | escape }}, {{ product.tags | join: ', ' | escape }}, {{ shop.name | escape }}">
{%- elsif template == 'article' -%}
  <meta name="keywords" content="{{ article.title | escape }}, {{ article.tags | join: ', ' | escape }}, {{ blog.title | escape }}, {{ shop.name | escape }}">
{%- endif -%}

<!-- Open Graph / Facebook -->
<meta property="og:type" content="{{ og_type }}">
<meta property="og:url" content="{{ og_url }}">
<meta property="og:title" content="{{ og_title | escape }}">
<meta property="og:description" content="{{ og_description | escape }}">
<meta property="og:image" content="{{ og_image }}">
<meta property="og:image:secure_url" content="{{ og_image | replace: 'http://', 'https://' }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="{{ og_title | escape }}">
<meta property="og:site_name" content="{{ shop.name | escape }}">
<meta property="og:locale" content="{{ request.locale.iso_code | replace: '-', '_' }}">

{%- if template == 'product' -%}
  <!-- 产品特定的Open Graph标签 -->
  <meta property="product:brand" content="{{ product.vendor | escape }}">
  <meta property="product:price:amount" content="{{ product.price | money_without_currency }}">
  <meta property="product:price:currency" content="{{ cart.currency.iso_code }}">
  {%- if product.compare_at_price > product.price -%}
    <meta property="product:original_price:amount" content="{{ product.compare_at_price | money_without_currency }}">
    <meta property="product:original_price:currency" content="{{ cart.currency.iso_code }}">
  {%- endif -%}
  <meta property="product:availability" content="{% if product.available %}in stock{% else %}out of stock{% endif %}">
  <meta property="product:condition" content="new">
  <meta property="product:retailer_item_id" content="{{ product.id }}">
{%- endif -%}

{%- if template == 'article' -%}
  <!-- 文章特定的Open Graph标签 -->
  <meta property="article:published_time" content="{{ article.published_at | date: '%Y-%m-%dT%H:%M:%S%z' }}">
  <meta property="article:modified_time" content="{{ article.updated_at | date: '%Y-%m-%dT%H:%M:%S%z' }}">
  <meta property="article:author" content="{{ article.author | escape }}">
  <meta property="article:section" content="{{ blog.title | escape }}">
  {%- for tag in article.tags limit: 5 -%}
    <meta property="article:tag" content="{{ tag | escape }}">
  {%- endfor -%}
{%- endif -%}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ og_title | escape }}">
<meta name="twitter:description" content="{{ og_description | escape }}">
<meta name="twitter:image" content="{{ og_image }}">
<meta name="twitter:image:alt" content="{{ og_title | escape }}">
{%- if settings.social_twitter_link != blank -%}
  <meta name="twitter:site" content="@{{ settings.social_twitter_link | split: '/' | last }}">
{%- endif -%}

<!-- Schema.org 结构化数据 -->
{%- if template == 'product' -%}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org/",
    "@type": "Product",
    "name": {{ product.title | json }},
    "description": {{ product.description | strip_html | strip | json }},
    "image": [
      {% for image in product.images limit: 5 %}
        {{ image | image_url: width: 800 | json }}{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    "brand": {
      "@type": "Brand",
      "name": {{ product.vendor | json }}
    },
    "sku": {{ product.selected_or_first_available_variant.sku | json }},
    "mpn": {{ product.selected_or_first_available_variant.barcode | json }},
    "offers": {
      "@type": "Offer",
      "url": {{ shop.url | append: product.url | json }},
      "priceCurrency": {{ cart.currency.iso_code | json }},
      "price": "{{ product.price | money_without_currency }}",
      "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' }}",
      "itemCondition": "https://schema.org/NewCondition",
      "availability": "https://schema.org/{% if product.available %}InStock{% else %}OutOfStock{% endif %}",
      "seller": {
        "@type": "Organization",
        "name": {{ shop.name | json }},
        "url": {{ shop.url | json }}
      }
    }
  }
  </script>

{%- elsif template == 'article' -%}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": {{ article.title | json }},
    "image": [
      {% if article.image %}
        {{ article.image | image_url: width: 1200 | json }}
      {% endif %}
    ],
    "datePublished": "{{ article.published_at | date: '%Y-%m-%dT%H:%M:%S%z' }}",
    "dateModified": "{{ article.updated_at | date: '%Y-%m-%dT%H:%M:%S%z' }}",
    "author": {
      "@type": "Person",
      "name": {{ article.author | json }}
    },
    "publisher": {
      "@type": "Organization",
      "name": {{ shop.name | json }},
      "logo": {
        "@type": "ImageObject",
        "url": {{ settings.logo | image_url: width: 600 | json }}
      }
    },
    "description": {{ article.excerpt | strip_html | strip | json }}
  }
  </script>

{%- elsif template == 'collection' -%}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": {{ collection.title | json }},
    "description": {{ collection.description | strip_html | strip | json }},
    "url": {{ shop.url | append: collection.url | json }},
    "hasPart": [
      {% for product in collection.products limit: 20 %}
        {
          "@type": "Product",
          "name": {{ product.title | json }},
          "url": {{ shop.url | append: product.url | json }},
          "image": {{ product.featured_image | image_url: width: 600 | json }},
          "offers": {
            "@type": "Offer",
            "price": "{{ product.price | money_without_currency }}",
            "priceCurrency": {{ cart.currency.iso_code | json }},
            "availability": "https://schema.org/{% if product.available %}InStock{% else %}OutOfStock{% endif %}"
          }
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
  </script>

{%- elsif template == 'blog' -%}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Blog",
    "name": {{ blog.title | json }},
    "description": {{ blog.description | strip_html | strip | json }},
    "url": {{ shop.url | append: blog.url | json }},
    "publisher": {
      "@type": "Organization",
      "name": {{ shop.name | json }}
    },
    "blogPost": [
      {% for article in blog.articles limit: 10 %}
        {
          "@type": "BlogPosting",
          "headline": {{ article.title | json }},
          "url": {{ shop.url | append: article.url | json }},
          "datePublished": "{{ article.published_at | date: '%Y-%m-%dT%H:%M:%S%z' }}",
          "author": {
            "@type": "Person",
            "name": {{ article.author | json }}
          }
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
  </script>

{%- elsif template == 'index' -%}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": {{ shop.name | json }},
    "url": {{ shop.url | json }},
    "logo": {{ settings.logo | image_url: width: 600 | json }},
    "description": {{ shop.description | strip_html | strip | json }},
    "sameAs": [
      {% if settings.social_twitter_link != blank %}{{ settings.social_twitter_link | json }},{% endif %}
      {% if settings.social_facebook_link != blank %}{{ settings.social_facebook_link | json }},{% endif %}
      {% if settings.social_instagram_link != blank %}{{ settings.social_instagram_link | json }},{% endif %}
      {% if settings.social_linkedin_url != blank %}{{ settings.social_linkedin_url | json }}{% endif %}
    ],
    "contactPoint": {
      "@type": "ContactPoint",
      "telephone": "{{ shop.phone | json }}",
      "contactType": "customer service",
      "availableLanguage": ["{{ request.locale.iso_code }}"]
    }
  }
  </script>

  <!-- 网站搜索框 -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "url": {{ shop.url | json }},
    "potentialAction": {
      "@type": "SearchAction",
      "target": "{{ shop.url }}/search?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>
{%- endif -%}

<!-- 面包屑导航结构化数据 -->
{%- if template != 'index' -%}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "首页",
        "item": {{ shop.url | json }}
      }
      {%- if template contains 'product' -%}
        ,
        {
          "@type": "ListItem",
          "position": 2,
          "name": {{ product.type | json }},
          "item": {{ shop.url | append: '/collections/all' | json }}
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": {{ product.title | json }},
          "item": {{ shop.url | append: product.url | json }}
        }
      {%- elsif template contains 'collection' -%}
        ,
        {
          "@type": "ListItem",
          "position": 2,
          "name": {{ collection.title | json }},
          "item": {{ shop.url | append: collection.url | json }}
        }
      {%- elsif template contains 'blog' -%}
        ,
        {
          "@type": "ListItem",
          "position": 2,
          "name": {{ blog.title | json }},
          "item": {{ shop.url | append: blog.url | json }}
        }
        {%- if template == 'article' -%}
        ,
        {
          "@type": "ListItem",
          "position": 3,
          "name": {{ article.title | json }},
          "item": {{ shop.url | append: article.url | json }}
        }
        {%- endif -%}
      {%- elsif template == 'page' -%}
        ,
        {
          "@type": "ListItem",
          "position": 2,
          "name": {{ page.title | json }},
          "item": {{ shop.url | append: page.url | json }}
        }
      {%- elsif template == 'search' -%}
        ,
        {
          "@type": "ListItem",
          "position": 2,
          "name": "搜索结果",
          "item": {{ shop.url | append: '/search' | json }}
        }
      {%- endif -%}
    ]
  }
  </script>
{%- endif -%}

<!-- 其他重要的SEO标签 -->
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="theme-color" content="{{ settings.color_secondary }}">
<meta name="msapplication-TileColor" content="{{ settings.color_secondary }}">
<meta name="application-name" content="{{ shop.name | escape }}">

<!-- PWA相关标签 -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="{{ shop.name | escape }}">

<!-- 预加载关键资源 -->
{%- if template contains 'product' and product.featured_image -%}
  <link rel="preload" as="image" href="{{ product.featured_image | image_url: width: 800 }}" importance="high">
{%- endif -%}

<!-- DNS预解析 -->
{%- if settings.social_twitter_link != blank -%}
  <link rel="dns-prefetch" href="//platform.twitter.com">
{%- endif -%}
{%- if settings.social_facebook_link != blank -%}
  <link rel="dns-prefetch" href="//www.facebook.com">
{%- endif -%}
<link rel="dns-prefetch" href="//www.google-analytics.com">

<!-- 机器人指令 -->
{%- if template contains 'customers' or template contains 'account' or template contains 'checkout' -%}
  <meta name="robots" content="noindex, nofollow">
{%- else -%}
  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
{%- endif -%}

<!-- 语言和地区 -->
{%- if request.locale.iso_code != 'zh-CN' -%}
  <link rel="alternate" hreflang="{{ request.locale.iso_code }}" href="{{ canonical_url }}">
  <link rel="alternate" hreflang="x-default" href="{{ canonical_url }}">
{%- endif -%}

<!-- 网站验证码（如果配置了） -->
{%- if settings.google_site_verification != blank -%}
  <meta name="google-site-verification" content="{{ settings.google_site_verification | escape }}">
{%- endif -%}
{%- if settings.bing_site_verification != blank -%}
  <meta name="msvalidate.01" content="{{ settings.bing_site_verification | escape }}">
{%- endif -%}