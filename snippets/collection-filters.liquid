{%- comment -%}
  收藏筛选组件
  提供产品筛选功能
{%- endcomment -%}

{%- if collection.filters.size > 0 -%}
  <div class="collection-filters" data-collection-filters>
    <!-- 筛选头部 -->
    <div class="filters-header">
      <h3 class="filters-title">筛选产品</h3>
      {%- if active_filters.size > 0 -%}
        <button type="button" class="filters-clear" data-clear-all-filters>
          清除所有 ({{ active_filters.size }})
        </button>
      {%- endif -%}
    </div>

    <!-- 活动筛选器 -->
    {%- if active_filters.size > 0 -%}
      <div class="active-filters" data-active-filters>
        <h4 class="active-filters-title">当前筛选</h4>
        <div class="active-filters-list">
          {%- for filter in active_filters -%}
            <div class="active-filter-item" data-filter-item>
              <span class="active-filter-label">{{ filter.label }}</span>
              <button type="button"
                      class="active-filter-remove"
                      data-filter-remove="{{ filter.param_name }}"
                      data-filter-value="{{ filter.value }}"
                      aria-label="移除 {{ filter.label }} 筛选">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                  <path d="M11 3L3 11M3 3l8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

    <!-- 筛选组 -->
    <form class="filters-form" data-filters-form>
      <div class="filters-content" data-filters-content>
        {%- for filter in collection.filters -%}
          {%- assign filter_id = filter.param_name | handle -%}
          <div class="filter-group" data-filter-group="{{ filter_id }}">
            <div class="filter-group-header">
              <h4 class="filter-group-title">
                {{ filter.label }}
                {%- if filter.active_values.size > 0 -%}
                  <span class="filter-active-count">({{ filter.active_values.size }})</span>
                {%- endif -%}
              </h4>
              <button type="button"
                      class="filter-toggle"
                      data-filter-toggle
                      aria-expanded="true"
                      aria-controls="FilterContent-{{ filter_id }}">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="filter-toggle-icon">
                  <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>

            <div class="filter-group-content" id="FilterContent-{{ filter_id }}" data-filter-content>
              {%- case filter.type -%}
                {%- when 'list' -%}
                  <div class="filter-list">
                    {%- assign sorted_values = filter.values | sort: 'count' | reverse -%}
                    {%- for filter_value in sorted_values -%}
                      {%- if filter_value.count > 0 or filter_value.active -%}
                        {%- assign value_id = filter.param_name | append: '-' | append: filter_value.value | handle -%}
                        <div class="filter-item" data-filter-item>
                          <label class="filter-label" for="Filter-{{ value_id }}">
                            <input type="checkbox"
                                   name="{{ filter.param_name }}"
                                   value="{{ filter_value.value }}"
                                   id="Filter-{{ value_id }}"
                                   {% if filter_value.active %}checked{% endif %}
                                   {% if filter_value.count == 0 %}disabled{% endif %}
                                   class="filter-input">

                            <span class="filter-checkbox">
                              <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor" class="checkbox-check">
                                <path d="M10 3L4.5 8.5L2 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </span>

                            {%- if filter.type == 'color' -%}
                              <span class="filter-swatch" data-swatch="{{ filter_value.value | handle }}">
                                <span class="filter-swatch-color" style="{% if filter_value.swatch.image %}background-image: url({{ filter_value.swatch.image | image_url: width: 24, height: 24 }});{% else %}background-color: {{ filter_value.swatch.color }};{% endif %}"></span>
                              </span>
                            {%- endif -%}

                            <span class="filter-text">{{ filter_value.label }}</span>
                            <span class="filter-count">({{ filter_value.count }})</span>
                          </label>
                        </div>
                      {%- endif -%}
                    {%- endfor -%}
                  </div>

                {%- when 'price_range' -%}
                  {%- liquid
                    assign currencies_using_comma_decimals = 'ANG,ARS,BRL,BYN,BYR,CLF,CLP,COP,CRC,CZK,DKK,EUR,HRK,HUF,IDR,ISK,MZN,NOK,PLN,RON,RUB,SEK,TRY,UYU,VES,VND' | split: ','
                    assign uses_comma_decimals = false
                    if currencies_using_comma_decimals contains cart.currency.iso_code
                      assign uses_comma_decimals = true
                    endif
                  -%}

                  <div class="price-range" data-price-range>
                    <div class="price-range-display">
                      <span class="price-range-label">价格范围:</span>
                      <span class="price-range-value" data-price-range-display>
                        {%- if filter.min_value.value -%}
                          {{ filter.min_value.value | money }} - {{ filter.max_value.value | money }}
                        {%- else -%}
                          任意价格
                        {%- endif -%}
                      </span>
                    </div>

                    <div class="price-range-inputs">
                      <div class="price-input-group">
                        <label class="price-input-label" for="Filter-Price-GTE-{{ filter_id }}">最低价</label>
                        <div class="price-input-wrapper">
                          <span class="price-currency">{{ cart.currency.symbol }}</span>
                          <input type="number"
                                 name="{{ filter.min_value.param_name }}"
                                 id="Filter-Price-GTE-{{ filter_id }}"
                                 {% if filter.min_value.value %}
                                   value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"
                                 {% endif %}
                                 class="price-input"
                                 placeholder="0"
                                 min="0"
                                 max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                                 data-price-min>
                        </div>
                      </div>

                      <div class="price-separator">-</div>

                      <div class="price-input-group">
                        <label class="price-input-label" for="Filter-Price-LTE-{{ filter_id }}">最高价</label>
                        <div class="price-input-wrapper">
                          <span class="price-currency">{{ cart.currency.symbol }}</span>
                          <input type="number"
                                 name="{{ filter.max_value.param_name }}"
                                 id="Filter-Price-LTE-{{ filter_id }}"
                                 {% if filter.max_value.value %}
                                   value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"
                                 {% endif %}
                                 class="price-input"
                                 placeholder="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                                 min="0"
                                 max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                                 data-price-max>
                        </div>
                      </div>
                    </div>

                    <!-- 价格滑块 -->
                    <div class="price-slider" data-price-slider>
                      <div class="price-slider-track">
                        <div class="price-slider-progress" data-slider-progress></div>
                      </div>
                      <input type="range"
                             class="price-slider-range price-slider-min"
                             data-slider-min
                             min="0"
                             max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                             value="{{ filter.min_value.value | money_without_currency | replace: ',', '' | default: 0 }}"
                             step="1">
                      <input type="range"
                             class="price-slider-range price-slider-max"
                             data-slider-max
                             min="0"
                             max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                             value="{{ filter.max_value.value | money_without_currency | replace: ',', '' | default: filter.range_max | money_without_currency | replace: ',', '' }}"
                             step="1">
                    </div>

                    <!-- 预设价格范围 -->
                    <div class="price-presets" data-price-presets>
                      <button type="button" class="price-preset" data-preset="0-100">¥0-100</button>
                      <button type="button" class="price-preset" data-preset="100-500">¥100-500</button>
                      <button type="button" class="price-preset" data-preset="500-1000">¥500-1000</button>
                      <button type="button" class="price-preset" data-preset="1000-9999">¥1000+</button>
                    </div>
                  </div>

              {%- endcase -%}

              <!-- 清除按钮 -->
              {%- if filter.active_values.size > 0 -%}
                <button type="button"
                        class="filter-clear-group"
                        data-clear-group="{{ filter.param_name }}"
                        aria-label="清除 {{ filter.label }} 筛选">
                  清除 {{ filter.label }}
                </button>
              {%- endif -%}
            </div>
          </div>
        {%- endfor -%}
      </div>

      <!-- 筛选操作按钮 -->
      <div class="filters-actions">
        <button type="submit" class="btn btn-primary apply-filters" data-apply-filters>
          应用筛选
        </button>
        <button type="reset" class="btn btn-secondary reset-filters" data-reset-filters>
          重置
        </button>
      </div>
    </form>
  </div>
{%- endif -%}

<style>
/* 收藏筛选器 */
.collection-filters {
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border-light);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

/* 筛选头部 */
.filters-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--spacing-4) var(--spacing-5);
  background: var(--color-bg-tertiary);
  border-bottom: 1px solid var(--color-border-light);
}

.filters-title {
  font-family: var(--font-family-heading);
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-primary);
  margin: 0;
}

.filters-clear {
  padding: var(--spacing-2) var(--spacing-3);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  color: var(--color-text-secondary);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-sci-fi);

  &:hover {
    border-color: var(--color-secondary);
    color: var(--color-secondary);
  }
}

/* 活动筛选器 */
.active-filters {
  padding: var(--spacing-4) var(--spacing-5);
  border-bottom: 1px solid var(--color-border-light);
}

.active-filters-title {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-primary);
  margin-bottom: var(--spacing-3);
}

.active-filters-list {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-2);
}

.active-filter-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
  padding: var(--spacing-1) var(--spacing-2);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  font-size: var(--font-size-xs);
}

.active-filter-label {
  color: var(--color-text-primary);
  font-weight: var(--font-weight-medium);
}

.active-filter-remove {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  background: transparent;
  border: none;
  color: var(--color-text-secondary);
  cursor: pointer;
  border-radius: 50%;
  transition: all var(--duration-normal) var(--ease-sci-fi);

  &:hover {
    background: var(--color-error);
    color: white;
  }
}

/* 筛选表单 */
.filters-form {
  /* 样式在父组件中定义 */
}

.filters-content {
  padding: var(--spacing-4) var(--spacing-5);
  max-height: 60vh;
  overflow-y: auto;

  &::-webkit-scrollbar {
    width: 6px;
  }

  &::-webkit-scrollbar-track {
    background: var(--color-bg-tertiary);
  }

  &::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 3px;

    &:hover {
      background: var(--color-secondary);
    }
  }
}

/* 筛选组 */
.filter-group {
  margin-bottom: var(--spacing-5);

  &:last-child {
    margin-bottom: 0;
  }
}

.filter-group-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--spacing-3);
}

.filter-group-title {
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-primary);
  margin: 0;
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
}

.filter-active-count {
  background: var(--color-secondary);
  color: var(--color-text-inverse);
  padding: 2px 6px;
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-semibold);
}

.filter-toggle {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-sci-fi);

  &:hover {
    border-color: var(--color-secondary);
    color: var(--color-secondary);
  }

  &[aria-expanded="true"] .filter-toggle-icon {
    transform: rotate(180deg);
  }
}

.filter-toggle-icon {
  transition: transform var(--duration-normal) var(--ease-sci-fi);
}

.filter-group-content {
  space-y: var(--spacing-2);
}

.filter-group-content[hidden] {
  display: none;
}

/* 筛选列表 */
.filter-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-2);
}

.filter-item {
  /* 样式在父组件中定义 */
}

.filter-label {
  display: flex;
  align-items: center;
  gap: var(--spacing-3);
  padding: var(--spacing-2) 0;
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-sci-fi);

  &:hover {
    color: var(--color-primary);
  }

  &:has(input:focus) {
    outline: 2px solid var(--color-secondary);
    outline-offset: 2px;
    border-radius: var(--radius-base);
  }
}

.filter-input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.filter-checkbox {
  position: relative;
  width: 20px;
  height: 20px;
  border: 2px solid var(--color-border);
  border-radius: var(--radius-sm);
  background: var(--color-bg-primary);
  transition: all var(--duration-normal) var(--ease-sci-fi);
  flex-shrink: 0;

  .checkbox-check {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    stroke: var(--color-text-inverse);
    transition: transform var(--duration-normal) var(--ease-sci-fi);
  }

  input:checked + & {
    background: var(--color-secondary);
    border-color: var(--color-secondary);
    box-shadow: 0 0 6px var(--glow-primary);

    .checkbox-check {
      transform: translate(-50%, -50%) scale(1);
    }
  }

  input:disabled + & {
    opacity: 0.5;
    cursor: not-allowed;
  }
}

.filter-swatch {
  width: 20px;
  height: 20px;
  border-radius: var(--radius-sm);
  border: 2px solid var(--color-border);
  flex-shrink: 0;
  overflow: hidden;
  position: relative;

  input:checked + .filter-label & {
    border-color: var(--color-secondary);
    box-shadow: 0 0 8px var(--glow-primary);
  }
}

.filter-swatch-color {
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
}

.filter-text {
  flex: 1;
  font-size: var(--font-size-sm);
  color: var(--color-text-primary);
}

.filter-count {
  font-size: var(--font-size-xs);
  color: var(--color-text-light);
  margin-left: auto;
}

/* 价格范围筛选 */
.price-range {
  margin-bottom: var(--spacing-3);
}

.price-range-display {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-4);
  padding: var(--spacing-3);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
}

.price-range-label {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-medium);
}

.price-range-value {
  font-size: var(--font-size-sm);
  color: var(--color-primary);
  font-weight: var(--font-weight-semibold);
}

.price-range-inputs {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: var(--spacing-3);
  align-items: end;
  margin-bottom: var(--spacing-4);
}

.price-input-group {
  /* 样式在父组件中定义 */
}

.price-input-label {
  display: block;
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-1);
}

.price-input-wrapper {
  position: relative;
}

.price-currency {
  position: absolute;
  top: 50%;
  left: var(--spacing-3);
  transform: translateY(-50%);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-medium);
}

.price-input {
  width: 100%;
  padding: var(--spacing-3) var(--spacing-3) var(--spacing-3) 24px;
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  font-size: var(--font-size-sm);
  color: var(--color-text-primary);
  transition: all var(--duration-normal) var(--ease-sci-fi);

  &:focus {
    outline: none;
    border-color: var(--color-secondary);
    box-shadow: 0 0 0 3px rgba(135, 206, 235, 0.1);
  }
}

.price-separator {
  align-self: center;
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-medium);
  margin-bottom: var(--spacing-1);
}

/* 价格滑块 */
.price-slider {
  margin: var(--spacing-4) 0;
  padding: var(--spacing-4) 0;
}

.price-slider-track {
  position: relative;
  height: 6px;
  background: var(--color-border-light);
  border-radius: 3px;
}

.price-slider-progress {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  background: var(--color-secondary);
  border-radius: 3px;
  transition: all var(--duration-normal) var(--ease-sci-fi);
}

.price-slider-range {
  position: absolute;
  top: -7px;
  width: 100%;
  height: 20px;
  background: transparent;
  cursor: pointer;
  pointer-events: none;

  &::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--color-primary);
    border: 3px solid white;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    pointer-events: all;
    transition: all var(--duration-normal) var(--ease-sci-fi);

    &:hover {
      transform: scale(1.1);
      box-shadow: 0 0 12px var(--glow-primary);
    }
  }

  &::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--color-primary);
    border: 3px solid white;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    pointer-events: all;
    transition: all var(--duration-normal) var(--ease-sci-fi);

    &:hover {
      transform: scale(1.1);
      box-shadow: 0 0 12px var(--glow-primary);
    }
  }
}

/* 价格预设 */
.price-presets {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-2);
  margin-top: var(--spacing-4);
}

.price-preset {
  padding: var(--spacing-2) var(--spacing-3);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  font-size: var(--font-size-xs);
  color: var(--color-text-primary);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-sci-fi);

  &:hover {
    border-color: var(--color-secondary);
    background: var(--color-secondary);
    color: var(--color-text-inverse);
  }

  &.active {
    background: var(--color-secondary);
    border-color: var(--color-secondary);
    color: var(--color-text-inverse);
    box-shadow: 0 0 8px var(--glow-primary);
  }
}

/* 筛选操作按钮 */
.filters-actions {
  display: flex;
  gap: var(--spacing-3);
  padding: var(--spacing-4) var(--spacing-5);
  background: var(--color-bg-tertiary);
  border-top: 1px solid var(--color-border-light);
}

.apply-filters,
.reset-filters {
  flex: 1;
  padding: var(--spacing-3);
  font-weight: var(--font-weight-medium);
  transition: all var(--duration-normal) var(--ease-sci-fi);
}

.filter-clear-group {
  margin-top: var(--spacing-3);
  padding: var(--spacing-2) 0;
  background: none;
  border: none;
  color: var(--color-secondary);
  font-size: var(--font-size-sm);
  cursor: pointer;
  font-weight: var(--font-weight-medium);
  text-align: left;
  transition: all var(--duration-normal) var(--ease-sci-fi);

  &:hover {
    color: var(--color-primary);
    text-decoration: underline;
  }
}

/* 响应式设计 */
@media (max-width: 768px) {
  .filters-header,
  .filters-content,
  .filters-actions {
    padding-left: var(--spacing-4);
    padding-right: var(--spacing-4);
  }

  .price-range-inputs {
    grid-template-columns: 1fr;
    gap: var(--spacing-2);
  }

  .price-separator {
    display: none;
  }

  .price-presets {
    grid-template-columns: 1fr;
  }

  .filters-actions {
    flex-direction: column;
  }

  .apply-filters,
  .reset-filters {
    width: 100%;
  }
}

/* 动画 */
.filter-group {
  animation: fadeInUp 0.4s ease-out backwards;

  @for $i from 1 through 10 {
    &:nth-child(#{$i}) {
      animation-delay: #{($i - 1) * 0.05}s;
    }
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* 减少动画 */
@media (prefers-reduced-motion: reduce) {
  .filter-group {
    animation: none;
  }

  .filter-toggle-icon,
  .filter-checkbox,
  .filter-swatch,
  .price-input,
  .price-slider-range {
    transition: none;
  }
}

/* 无障碍支持 */
.filter-group:focus-within {
  outline: 2px solid var(--color-secondary);
  outline-offset: 2px;
  border-radius: var(--radius-base);
}

/* 高对比度模式 */
@media (prefers-contrast: high) {
  .filter-checkbox,
  .filter-swatch {
    border-width: 3px;
  }

  .price-input {
    border-width: 2px;
  }
}

/* 打印样式 */
@media print {
  .collection-filters {
    display: none;
  }
}
</style>