{%- comment -%}
  信用卡支付表单组件
{%- endcomment -%}

<div class="credit-card-form" data-credit-card-form>
  <div class="payment-form-section">
    <div class="payment-form-title">信用卡信息</div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="card_number">卡号 *</label>
        <div class="card-number-input-wrapper">
          <input type="text"
                 id="card_number"
                 name="card_number"
                 class="form-input"
                 placeholder="1234 5678 9012 3456"
                 maxlength="19"
                 required
                 data-card-number>
          <div class="card-type-icon" data-card-type-icon>
            <svg width="32" height="20" viewBox="0 0 32 20" fill="none">
              <rect width="32" height="20" rx="2" fill="#e0e0e0"/>
            </svg>
          </div>
        </div>
        <div class="field-error" data-field-error="card_number"></div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="card_name">持卡人姓名 *</label>
        <input type="text"
               id="card_name"
               name="card_name"
               class="form-input"
               placeholder="张三"
               required
               data-card-name>
        <div class="field-error" data-field-error="card_name"></div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="card_expiry">有效期 *</label>
        <input type="text"
               id="card_expiry"
               name="card_expiry"
               class="form-input"
               placeholder="MM/YY"
               maxlength="5"
               required
               data-card-expiry>
        <div class="field-error" data-field-error="card_expiry"></div>
      </div>
      <div class="form-group">
        <label class="form-label" for="card_cvv">CVV *</label>
        <div class="cvv-input-wrapper">
          <input type="text"
                 id="card_cvv"
                 name="card_cvv"
                 class="form-input"
                 placeholder="123"
                 maxlength="4"
                 required
                 data-card-cvv>
          <button type="button" class="cvv-help-button" data-cvv-help>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <text x="8" y="12" text-anchor="middle" font-size="10" font-weight="bold">?</text>
            </svg>
          </button>
        </div>
        <div class="field-error" data-field-error="card_cvv"></div>
      </div>
    </div>

    <!-- 分期付款选项 -->
    <div class="form-group" id="installment_options" style="display: none;">
      <label class="form-label" for="card_installments">分期付款</label>
      <select id="card_installments" name="card_installments" class="form-select" data-card-installments>
        <option value="1">一次性付清</option>
        <option value="3">3期 - 免息</option>
        <option value="6">6期 - 免息</option>
        <option value="12">12期 - 低手续费</option>
        <option value="24">24期 - 低手续费</option>
      </select>
      <div class="installment-info" data-installment-info></div>
    </div>

    <!-- 储蓄卡/信用卡切换 -->
    <div class="card-type-toggle">
      <label class="radio-label">
        <input type="radio" name="card_type" value="credit" checked data-card-type>
        <span class="radio-text">信用卡</span>
      </label>
      <label class="radio-label">
        <input type="radio" name="card_type" value="debit" data-card-type>
        <span class="radio-text">储蓄卡</span>
      </label>
    </div>
  </div>

  <!-- 安全提示 -->
  <div class="security-info">
    <div class="security-icon">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="var(--checkout-success)">
        <path d="M8 1l6 3v5c0 2.5-2.5 5-6 6.5-3.5-1.5-6-4-6-6.5V4l6-3z"/>
        <path d="M6 7l2 2 4-4" stroke="white" stroke-width="1"5" fill="none"/>
      </svg>
    </div>
    <div class="security-text">
      您的支付信息经过SSL加密保护，安全可靠
    </div>
  </div>

  <!-- 支持的卡类型 -->
  <div class="supported-cards">
    <span class="supported-cards-label">支持的卡类型:</span>
    <div class="supported-card-icons">
      <img src="{{ 'visa.svg' | asset_url }}" alt="Visa" class="supported-card-icon">
      <img src="{{ 'mastercard.svg' | asset_url }}" alt="Mastercard" class="supported-card-icon">
      <img src="{{ 'amex.svg' | asset_url }}" alt="American Express" class="supported-card-icon">
      <img src="{{ 'discover.svg' | asset_url }}" alt="Discover" class="supported-card-icon">
      <img src="{{ 'jcb.svg' | asset_url }}" alt="JCB" class="supported-card-icon">
    </div>
  </div>
</div>

<!-- CVV帮助弹窗 -->
<div class="cvv-help-modal" id="cvv_help_modal">
  <div class="cvv-help-content">
    <div class="cvv-help-header">
      <h3>CVV安全码说明</h3>
      <button type="button" class="cvv-help-close" data-cvv-help-close>&times;</button>
    </div>
    <div class="cvv-help-body">
      <div class="cvv-help-item">
        <div class="cvv-help-image">
          <img src="{{ 'cvv-back.svg' | asset_url }}" alt="CVV位置 - Visa/Mastercard">
        </div>
        <div class="cvv-help-text">
          <h4>Visa/Mastercard</h4>
          <p>3位数字，位于卡片背面的签名条上</p>
        </div>
      </div>
      <div class="cvv-help-item">
        <div class="cvv-help-image">
          <img src="{{ 'cvv-front.svg' | asset_url }}" alt="CVV位置 - American Express">
        </div>
        <div class="cvv-help-text">
          <h4>American Express</h4>
          <p>4位数字，位于卡片正面，卡号上方</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .credit-card-form {
    padding: var(--spacing-4);
  }

  .payment-form-section {
    margin-bottom: var(--spacing-4);
  }

  .payment-form-title {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--checkout-text-primary);
    margin-bottom: var(--spacing-3);
  }

  .card-number-input-wrapper {
    position: relative;
  }

  .card-type-icon {
    position: absolute;
    right: var(--spacing-3);
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 20px;
  }

  .card-type-icon.visa {
    background: url('{{ 'visa-icon.svg' | asset_url }}') center/contain no-repeat;
  }

  .card-type-icon.mastercard {
    background: url('{{ 'mastercard-icon.svg' | asset_url }}') center/contain no-repeat;
  }

  .card-type-icon.amex {
    background: url('{{ 'amex-icon.svg' | asset_url }}') center/contain no-repeat;
  }

  .cvv-input-wrapper {
    position: relative;
  }

  .cvv-help-button {
    position: absolute;
    right: var(--spacing-2);
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--checkout-text-secondary);
    cursor: pointer;
    padding: var(--spacing-1);
    border-radius: 50%;
    transition: all var(--duration-normal);
  }

  .cvv-help-button:hover {
    background: var(--checkout-bg-tertiary);
    color: var(--checkout-primary);
  }

  .card-type-toggle {
    display: flex;
    gap: var(--spacing-4);
    margin-top: var(--spacing-3);
  }

  .radio-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    cursor: pointer;
  }

  .security-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-3);
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid var(--checkout-success);
    border-radius: var(--checkout-radius);
    margin-top: var(--spacing-3);
  }

  .security-icon {
    color: var(--checkout-success);
  }

  .security-text {
    font-size: var(--font-size-sm);
    color: var(--checkout-success);
  }

  .supported-cards {
    margin-top: var(--spacing-3);
    padding-top: var(--spacing-3);
    border-top: 1px solid var(--checkout-border-light);
  }

  .supported-cards-label {
    font-size: var(--font-size-sm);
    color: var(--checkout-text-secondary);
    margin-right: var(--spacing-2);
  }

  .supported-card-icons {
    display: inline-flex;
    gap: var(--spacing-2);
    align-items: center;
  }

  .supported-card-icon {
    width: 32px;
    height: 20px;
    opacity: 0.6;
    transition: opacity var(--duration-normal);
  }

  .supported-card-icon:hover {
    opacity: 1;
  }

  .installment-info {
    margin-top: var(--spacing-2);
    font-size: var(--font-size-sm);
    color: var(--checkout-text-secondary);
  }

  /* CVV帮助弹窗 */
  .cvv-help-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .cvv-help-modal.show {
    display: flex;
  }

  .cvv-help-content {
    background: white;
    border-radius: var(--checkout-radius);
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }

  .cvv-help-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-4);
    border-bottom: 1px solid var(--checkout-border);
  }

  .cvv-help-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--checkout-text-secondary);
  }

  .cvv-help-body {
    padding: var(--spacing-4);
  }

  .cvv-help-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    margin-bottom: var(--spacing-4);
  }

  .cvv-help-item:last-child {
    margin-bottom: 0;
  }

  .cvv-help-image {
    width: 80px;
    height: 50px;
    flex-shrink: 0;
  }

  .cvv-help-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .cvv-help-text h4 {
    margin: 0 0 var(--spacing-1) 0;
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--checkout-text-primary);
  }

  .cvv-help-text p {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--checkout-text-secondary);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const cardNumberInput = document.querySelector('[data-card-number]');
    const cardNameInput = document.querySelector('[data-card-name]');
    const cardExpiryInput = document.querySelector('[data-card-expiry]');
    const cardCvvInput = document.querySelector('[data-card-cvv]');
    const cardTypeIcon = document.querySelector('[data-card-type-icon]');
    const installmentSelect = document.querySelector('[data-card-installments]');
    const installmentOptions = document.querySelector('#installment_options');
    const cvvHelpButton = document.querySelector('[data-cvv-help]');
    const cvvHelpModal = document.querySelector('#cvv_help_modal');
    const cvvHelpClose = document.querySelector('[data-cvv-help-close]');

    // 卡号格式化和识别
    cardNumberInput?.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
      let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;

      e.target.value = formattedValue;

      // 识别卡类型
      const cardType = detectCardType(value);
      updateCardTypeIcon(cardType);

      // 显示分期选项
      if (cardType && value.length >= 16) {
        installmentOptions.style.display = 'block';
        updateInstallmentOptions();
      } else {
        installmentOptions.style.display = 'none';
      }
    });

    // 有效期格式化
    cardExpiryInput?.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');

      if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2, 4);
      }

      e.target.value = value;
    });

    // CVV格式化
    cardCvvInput?.addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });

    // 卡类型切换
    document.querySelectorAll('[data-card-type]').forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.value === 'debit') {
          installmentOptions.style.display = 'none';
        }
      });
    });

    // CVV帮助弹窗
    cvvHelpButton?.addEventListener('click', function() {
      cvvHelpModal.classList.add('show');
    });

    cvvHelpClose?.addEventListener('click', function() {
      cvvHelpModal.classList.remove('show');
    });

    cvvHelpModal?.addEventListener('click', function(e) {
      if (e.target === cvvHelpModal) {
        cvvHelpModal.classList.remove('show');
      }
    });

    // 识别卡类型
    function detectCardType(number) {
      if (!number) return null;

      const patterns = {
        visa: /^4/,
        mastercard: /^5[1-5]/,
        amex: /^3[47]/,
        discover: /^6(?:011|5[0-9]{2})/,
        jcb: /^(?:2131|1800|35\d{3})/
      };

      for (const [type, pattern] of Object.entries(patterns)) {
        if (pattern.test(number)) {
          return type;
        }
      }

      return null;
    }

    // 更新卡类型图标
    function updateCardTypeIcon(cardType) {
      if (!cardTypeIcon) return;

      cardTypeIcon.className = 'card-type-icon';

      if (cardType) {
        cardTypeIcon.classList.add(cardType);
      }
    }

    // 更新分期选项
    function updateInstallmentOptions() {
      if (!installmentSelect) return;

      // 可以根据卡类型和金额调整可用分期数
      // 这里只是一个示例实现
    }

    // 表单验证
    function validateCreditCardForm() {
      let isValid = true;

      // 验证卡号
      if (cardNumberInput && !validateCardNumber(cardNumberInput.value)) {
        showFieldError(cardNumberInput, '请输入有效的卡号');
        isValid = false;
      }

      // 验证持卡人姓名
      if (cardNameInput && cardNameInput.value.trim().length < 2) {
        showFieldError(cardNameInput, '请输入持卡人姓名');
        isValid = false;
      }

      // 验证有效期
      if (cardExpiryInput && !validateExpiry(cardExpiryInput.value)) {
        showFieldError(cardExpiryInput, '请输入有效的有效期');
        isValid = false;
      }

      // 验证CVV
      if (cardCvvInput && !validateCVV(cardCvvInput.value)) {
        showFieldError(cardCvvInput, '请输入有效的CVV');
        isValid = false;
      }

      return isValid;
    }

    function validateCardNumber(number) {
      const digits = number.replace(/\s+/g, '');

      if (!/^\d+$/.test(digits) || digits.length < 13 || digits.length > 19) {
        return false;
      }

      // Luhn算法验证
      let sum = 0;
      let isEven = false;

      for (let i = digits.length - 1; i >= 0; i--) {
        let digit = parseInt(digits[i]);

        if (isEven) {
          digit *= 2;
          if (digit > 9) {
            digit -= 9;
          }
        }

        sum += digit;
        isEven = !isEven;
      }

      return sum % 10 === 0;
    }

    function validateExpiry(expiry) {
      const match = expiry.match(/^(\d{2})\/(\d{2})$/);

      if (!match) return false;

      const month = parseInt(match[1]);
      const year = parseInt(match[2]) + 2000;
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1;

      if (month < 1 || month > 12) return false;

      if (year < currentYear || (year === currentYear && month < currentMonth)) {
        return false;
      }

      return true;
    }

    function validateCVV(cvv) {
      return /^\d{3,4}$/.test(cvv);
    }

    function showFieldError(field, message) {
      field.classList.add('error');

      const errorElement = field.parentElement.querySelector('.field-error');
      if (errorElement) {
        errorElement.textContent = message;
      }
    }

    // 导出验证函数供外部使用
    window.validateCreditCardForm = validateCreditCardForm;
  });
</script>