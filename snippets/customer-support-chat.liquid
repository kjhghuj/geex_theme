{% comment %}
  Âú®Á∫øÂÆ¢ÊúçËÅäÂ§©ÁªÑ‰ª∂
  Êèê‰æõÂÆûÊó∂ËÅäÂ§©„ÄÅÁ¶ªÁ∫øÁïôË®Ä„ÄÅÊô∫ËÉΩÂÆ¢ÊúçÁ≠âÂäüËÉΩ

  Parameters:
  - position: ËÅäÂ§©Á™óÂè£‰ΩçÁΩÆÔºàÂèØÈÄâÔºåÈªòËÆ§bottom-rightÔºâ
  - theme: ‰∏ªÈ¢òÊ†∑ÂºèÔºàÂèØÈÄâÔºåÈªòËÆ§scifiÔºâ
  - show_when_offline: Á¶ªÁ∫øÊó∂ÊòØÂê¶ÊòæÁ§∫ÔºàÂèØÈÄâÔºåÈªòËÆ§trueÔºâ
{% endcomment %}

{%- assign chat_position = position | default: 'bottom-right' -%}
{%- assign chat_theme = theme | default: 'scifi' -%}
{%- assign show_when_offline = show_when_offline | default: true -%}

<div class="customer-support-chat" data-chat-widget data-theme="{{ chat_theme }}" data-position="{{ chat_position }}">
  <!-- ËÅäÂ§©ÊåâÈíÆ -->
  <button type="button"
          class="chat-toggle"
          data-chat-toggle
          aria-label="{{ 'customer_support.open_chat' | t }}"
          aria-expanded="false">
    <div class="chat-toggle__icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="chat-icon">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2z"/>
      </svg>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="close-icon" hidden>
        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
      </svg>
    </div>
    <div class="chat-toggle__badge" data-chat-badge hidden>
      <span class="chat-toggle__badge-text">1</span>
    </div>
    <div class="chat-toggle__pulse"></div>
  </button>

  <!-- ËÅäÂ§©Á™óÂè£ -->
  <div class="chat-window" data-chat-window hidden>
    <!-- ËÅäÂ§©Â§¥ÈÉ® -->
    <div class="chat-header">
      <div class="chat-header__info">
        <div class="chat-header__avatar">
          {% if settings.support_avatar %}
            <img src="{{ settings.support_avatar | image_url: width: 48, height: 48 }}"
                 alt="{{ 'customer_support.agent' | t }}"
                 loading="lazy">
          {% else %}
            <div class="chat-header__avatar-placeholder">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c1.9 0 3.7-.5 5.2-1.4L22 22l-1.4-4.8C21.5 15.7 22 13.9 22 12c0-5.5-4.5-10-10-10zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </div>
          {% endif %}
        </div>
        <div class="chat-header__details">
          <h3 class="chat-header__title">{{ 'customer_support.live_support' | t }}</h3>
          <div class="chat-header__status" data-chat-status>
            <span class="status-indicator status-indicator--online"></span>
            <span class="status-text">{{ 'customer_support.online' | t }}</span>
          </div>
        </div>
      </div>
      <div class="chat-header__actions">
        <button type="button"
                class="chat-header__action"
                data-chat-minimize
                aria-label="{{ 'general.accessibility.minimize' | t }}">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M5 10h10M5 10l5-5M5 10l5 5" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
        </button>
        <button type="button"
                class="chat-header__action"
                data-chat-popout
                aria-label="{{ 'customer_support.open_in_window' | t }}">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M5 5h10M15 5v10M5 15l10-10" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- ËÅäÂ§©ÂÜÖÂÆπÂå∫ -->
    <div class="chat-content">
      <!-- Ê¨¢ËøéÊ∂àÊÅØ -->
      <div class="chat-welcome" data-chat-welcome>
        <div class="chat-welcome__avatar">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="currentColor">
            <path d="M16 2C8.3 2 2 8.3 2 16s6.3 14 14 14c1.9 0 3.7-.5 5.2-1.4L30 30l-1.4-6.8C29.5 21.7 30 19.9 30 18c0-7.7-6.3-14-14-14zm0 24c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8z"/>
            <circle cx="16" cy="16" r="4"/>
          </svg>
        </div>
        <div class="chat-welcome__content">
          <h4 class="chat-welcome__title">{{ 'customer_support.welcome_title' | t }}</h4>
          <p class="chat-welcome__message">{{ 'customer_support.welcome_message' | t }}</p>
          <div class="chat-welcome__quick-actions">
            <button type="button" class="quick-action" data-quick-action="order">
              {{ 'customer_support.track_order' | t }}
            </button>
            <button type="button" class="quick-action" data-quick-action="return">
              {{ 'customer_support.return_policy' | t }}
            </button>
            <button type="button" class="quick-action" data-quick-action="shipping">
              {{ 'customer_support.shipping_info' | t }}
            </button>
          </div>
        </div>
      </div>

      <!-- Ê∂àÊÅØÂàóË°® -->
      <div class="chat-messages" data-chat-messages>
        <!-- Ê∂àÊÅØ‰ºöÂä®ÊÄÅÊ∑ªÂä†Âà∞ËøôÈáå -->
      </div>

      <!-- ËæìÂÖ•ÊèêÁ§∫ -->
      <div class="chat-typing" data-chat-typing hidden>
        <div class="typing-indicator">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
      </div>
    </div>

    <!-- ËÅäÂ§©ËæìÂÖ•Âå∫ -->
    <div class="chat-footer">
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <textarea class="chat-input"
                    data-chat-input
                    placeholder="{{ 'customer_support.type_message' | t }}"
                    rows="1"
                    maxlength="500"
                    aria-label="{{ 'customer_support.type_message' | t }}"></textarea>
          <button type="button"
                  class="chat-attachment"
                  data-chat-attachment
                  aria-label="{{ 'customer_support.attach_file' | t }}">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M8 2v12M4 6h8M6 2l-2 4v6a2 2 0 002 2h4a2 2 0 002-2V6l-2-4H6z"/>
            </svg>
          </button>
          <button type="button"
                  class="chat-emoji"
                  data-chat-emoji
                  aria-label="{{ 'customer_support.add_emoji' | t }}">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
              <circle cx="7" cy="8" r="1" fill="currentColor"/>
              <circle cx="13" cy="8" r="1" fill="currentColor"/>
              <path d="M6 13c1.5-1 4.5-1 6 0" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
          </button>
        </div>
        <button type="button"
                class="chat-send"
                data-chat-send
                aria-label="{{ 'customer_support.send_message' | t }}"
                disabled>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M2 10l16-8M2 10l4 4M2 10l4-4M18 2l-8 16M18 2l-4 4" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
        </button>
      </div>

      <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
      <div class="chat-upload-area" data-chat-upload hidden>
        <input type="file"
               class="chat-file-input"
               data-chat-file-input
               accept="image/*,.pdf,.doc,.docx"
               multiple>
        <div class="upload-dropzone">
          <svg width="48" height="48" viewBox="0 0 48 48" fill="currentColor" class="upload-icon">
            <path d="M24 8v16M16 16l8 8 8-8" stroke="currentColor" stroke-width="2" fill="none"/>
            <rect x="4" y="32" width="40" height="8" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
          <p class="upload-text">{{ 'customer_support.drag_files' | t }}</p>
          <button type="button" class="upload-button">
            {{ 'customer_support.browse_files' | t }}
          </button>
          <button type="button" class="upload-cancel" data-chat-upload-cancel>
            {{ 'general.cancel' | t }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Á¶ªÁ∫øË°®Âçï -->
  <div class="chat-offline-form" data-chat-offline-form hidden>
    <div class="offline-form__header">
      <h3 class="offline-form__title">{{ 'customer_support.leave_message' | t }}</h3>
      <p class="offline-form__description">{{ 'customer_support.we_will_reply' | t }}</p>
    </div>

    <form class="offline-form" data-offline-form>
      <div class="form-group">
        <label for="chat-name" class="form-label">{{ 'customer_support.your_name' | t }} *</label>
        <input type="text"
               id="chat-name"
               name="name"
               class="form-input"
               required
               aria-required="true">
      </div>

      <div class="form-group">
        <label for="chat-email" class="form-label">{{ 'customer_support.your_email' | t }} *</label>
        <input type="email"
               id="chat-email"
               name="email"
               class="form-input"
               required
               aria-required="true">
      </div>

      <div class="form-group">
        <label for="chat-subject" class="form-label">{{ 'customer_support.subject' | t }}</label>
        <select id="chat-subject" name="subject" class="form-select">
          <option value="">{{ 'customer_support.select_topic' | t }}</option>
          <option value="order">{{ 'customer_support.order_inquiry' | t }}</option>
          <option value="return">{{ 'customer_support.return_request' | t }}</option>
          <option value="shipping">{{ 'customer_support.shipping_question' | t }}</option>
          <option value="payment">{{ 'customer_support.payment_issue' | t }}</option>
          <option value="technical">{{ 'customer_support.technical_support' | t }}</option>
          <option value="other">{{ 'customer_support.other' | t }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="chat-message" class="form-label">{{ 'customer_support.message' | t }} *</label>
        <textarea id="chat-message"
                  name="message"
                  class="form-textarea"
                  rows="4"
                  required
                  aria-required="true"
                  placeholder="{{ 'customer_support.message_placeholder' | t }}"></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn--primary" data-chat-submit>
          {{ 'customer_support.send_message' | t }}
        </button>
        <button type="button" class="btn btn--secondary" data-chat-cancel>
          {{ 'general.cancel' | t }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ËÅäÂ§©Èü≥È¢ëÈÄöÁü• -->
<audio id="chat-notification-sound" preload="auto">
  <source src="{{ 'chat-notification.mp3' | asset_url }}" type="audio/mpeg">
  <source src="{{ 'chat-notification.ogg' | asset_url }}" type="audio/ogg">
</audio>

<style>
  .customer-support-chat {
    position: fixed;
    z-index: var(--z-modal);
    font-family: var(--font-family-body);
  }

  /* ‰ΩçÁΩÆÊ†∑Âºè */
  .customer-support-chat[data-position="bottom-right"] {
    bottom: var(--spacing-4);
    right: var(--spacing-4);
  }

  .customer-support-chat[data-position="bottom-left"] {
    bottom: var(--spacing-4);
    left: var(--spacing-4);
  }

  .customer-support-chat[data-position="top-right"] {
    top: var(--spacing-4);
    right: var(--spacing-4);
  }

  .customer-support-chat[data-position="top-left"] {
    top: var(--spacing-4);
    left: var(--spacing-4);
  }

  /* ËÅäÂ§©ÊåâÈíÆ */
  .chat-toggle {
    position: relative;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--color-secondary), var(--color-accent));
    border: none;
    border-radius: var(--radius-full);
    color: var(--color-text-inverse);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-sci-fi);
    box-shadow: var(--shadow-large);
    @include glow(var(--glow-size-medium, var(--color-secondary), 0.6);

    &:hover {
      transform: translateY(-2px) scale(1.05);
      @include glow(var(--glow-size-large, var(--color-secondary), 0.8);
    }

    &:focus {
      outline: none;
      @include glow(var(--glow-size-large, var(--color-accent), 0.8);
    }

    &[aria-expanded="true"] {
      .chat-icon {
        display: none;
      }

      .close-icon {
        display: block;
      }
    }
  }

  .chat-toggle__icon {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chat-toggle__badge {
    position: absolute;
    top: -4px;
    right: -4px;
    min-width: 20px;
    height: 20px;
    background: var(--color-error);
    color: var(--color-text-inverse);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-bold);
    display: flex;
    align-items: center;
    justify-content: center;
    @include glow(var(--glow-size-small, var(--color-error), 0.8);
    animation: badge-pulse 2s ease-in-out infinite;
  }

  @keyframes badge-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  .chat-toggle__pulse {
    position: absolute;
    inset: -4px;
    border-radius: var(--radius-full);
    background: var(--color-secondary);
    opacity: 0;
    animation: pulse-ring 2s ease-out infinite;
  }

  @keyframes pulse-ring {
    0% {
      transform: scale(0.8);
      opacity: 0.6;
    }
    100% {
      transform: scale(1.5);
      opacity: 0;
    }
  }

  /* ËÅäÂ§©Á™óÂè£ */
  .chat-window {
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 380px;
    height: 600px;
    background: var(--color-bg-primary);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-extra-large);
    border: 1px solid var(--color-border);
    overflow: hidden;
    @include scifi-card();
    transform: translateY(20px);
    opacity: 0;
    visibility: hidden;
    transition: all var(--duration-normal) var(--ease-sci-fi);

    &[hidden] {
      display: none;
    }

    &.visible {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }
  }

  /* ‰ΩçÁΩÆË∞ÉÊï¥ */
  .customer-support-chat[data-position="bottom-left"] .chat-window,
  .customer-support-chat[data-position="top-left"] .chat-window {
    right: auto;
    left: 0;
  }

  .customer-support-chat[data-position="top-right"] .chat-window,
  .customer-support-chat[data-position="top-left"] .chat-window {
    bottom: auto;
    top: 80px;
  }

  /* ËÅäÂ§©Â§¥ÈÉ® */
  .chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-4);
    background: linear-gradient(135deg, var(--color-secondary), var(--color-accent));
    color: var(--color-text-inverse);
  }

  .chat-header__info {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
  }

  .chat-header__avatar {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-full);
    overflow: hidden;
    border: 2px solid rgba(255, 255, 255, 0.3);
    @include glow(var(--glow-size-small, rgba(255, 255, 255, 0.4);

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  }

  .chat-header__avatar-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.2);
  }

  .chat-header__details {
    flex: 1;
  }

  .chat-header__title {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    margin: 0 0 var(--spacing-1);
  }

  .chat-header__status {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--font-size-xs);
  }

  .status-indicator {
    width: 8px;
    height: 8px;
    border-radius: var(--radius-full);
    @include glow(var(--glow-size-small, currentColor, 0.6);

    &--online {
      background: var(--color-success);
    }

    &--offline {
      background: var(--color-text-light);
    }

    &--busy {
      background: var(--color-warning);
    }
  }

  .chat-header__actions {
    display: flex;
    gap: var(--spacing-2);
  }

  .chat-header__action {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: var(--radius-base);
    color: var(--color-text-inverse);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);

    &:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    &:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.3);
    }
  }

  /* ËÅäÂ§©ÂÜÖÂÆπÂå∫ */
  .chat-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: calc(100% - 140px);
    overflow: hidden;
  }

  /* Ê¨¢ËøéÊ∂àÊÅØ */
  .chat-welcome {
    display: flex;
    gap: var(--spacing-3);
    padding: var(--spacing-4);
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
  }

  .chat-welcome__avatar {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-secondary);
    color: var(--color-text-inverse);
    border-radius: var(--radius-full);
  }

  .chat-welcome__title {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin: 0 0 var(--spacing-2);
  }

  .chat-welcome__message {
    font-size: var(--font-size-sm);
    color: var(--color-text-light);
    margin: 0 0 var(--spacing-3);
    line-height: 1.4;
  }

  .chat-welcome__quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2);
  }

  .quick-action {
    padding: var(--spacing-2) var(--spacing-3);
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    color: var(--color-text-primary);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);

    &:hover {
      background: var(--color-secondary);
      color: var(--color-text-inverse);
      border-color: var(--color-secondary);
      transform: translateY(-1px);
      @include glow(var(--glow-size-small, var(--color-secondary), 0.4);
    }
  }

  /* Ê∂àÊÅØÂàóË°® */
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-3);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .chat-message {
    display: flex;
    gap: var(--spacing-2);
    max-width: 80%;
    animation: messageSlideIn 0.3s ease-out;

    &.message--sent {
      align-self: flex-end;
      flex-direction: row-reverse;

      .message-bubble {
        background: var(--color-secondary);
        color: var(--color-text-inverse);
        @include glow(var(--glow-size-small, var(--color-secondary), 0.3);
      }
    }

    &.message--received {
      align-self: flex-start;

      .message-bubble {
        background: var(--color-bg-secondary);
        color: var(--color-text-primary);
        border: 1px solid var(--color-border);
      }
    }
  }

  @keyframes messageSlideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message-avatar {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-full);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-inverse);
  }

  .message--sent .message-avatar {
    background: var(--color-secondary);
  }

  .message--received .message-avatar {
    background: var(--color-accent);
  }

  .message-content {
    flex: 1;
    min-width: 0;
  }

  .message-bubble {
    padding: var(--spacing-3);
    border-radius: var(--radius-lg);
    word-wrap: break-word;
    line-height: 1.4;
    position: relative;

    &::before {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
    }
  }

  .message--sent .message-bubble::before {
    right: -6px;
    border-width: 6px 0 6px 8px;
    border-color: transparent transparent transparent var(--color-secondary);
  }

  .message--received .message-bubble::before {
    left: -6px;
    border-width: 6px 8px 6px 0;
    border-color: transparent var(--color-bg-secondary) transparent transparent;
  }

  .message-time {
    font-size: var(--font-size-xs);
    color: var(--color-text-light);
    margin-top: var(--spacing-1);
    text-align: right;
  }

  /* ËæìÂÖ•ÊèêÁ§∫ */
  .chat-typing {
    padding: var(--spacing-3);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  .typing-indicator {
    display: flex;
    gap: var(--spacing-1);
    padding: var(--spacing-2) var(--spacing-3);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
  }

  .typing-dot {
    width: 6px;
    height: 6px;
    background: var(--color-text-light);
    border-radius: var(--radius-full);
    animation: typingDot 1.4s ease-in-out infinite;

    &:nth-child(2) {
      animation-delay: 0.2s;
    }

    &:nth-child(3) {
      animation-delay: 0.4s;
    }
  }

  @keyframes typingDot {
    0%, 60%, 100% {
      transform: translateY(0);
      opacity: 0.4;
    }
    30% {
      transform: translateY(-10px);
      opacity: 1;
    }
  }

  /* ËÅäÂ§©ËæìÂÖ•Âå∫ */
  .chat-footer {
    border-top: 1px solid var(--color-border);
    background: var(--color-bg-primary);
  }

  .chat-input-container {
    display: flex;
    align-items: flex-end;
    gap: var(--spacing-2);
    padding: var(--spacing-3);
  }

  .chat-input-wrapper {
    flex: 1;
    display: flex;
    align-items: flex-end;
    background: var(--color-bg-secondary);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all var(--duration-normal) var(--ease-out);

    &:focus-within {
      border-color: var(--color-secondary);
      @include glow(var(--glow-size-small, var(--color-secondary), 0.3);
    }
  }

  .chat-input {
    flex: 1;
    border: none;
    background: transparent;
    resize: none;
    outline: none;
    font-size: var(--font-size-sm);
    line-height: 1.4;
    padding: var(--spacing-3);
    max-height: 100px;
    min-height: 20px;
    color: var(--color-text-primary);

    &::placeholder {
      color: var(--color-text-light);
    }
  }

  .chat-attachment,
  .chat-emoji,
  .chat-send {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: none;
    border: none;
    color: var(--color-text-light);
    cursor: pointer;
    border-radius: var(--radius-base);
    transition: all var(--duration-fast) var(--ease-out);

    &:hover {
      background: rgba(135, 206, 235, 0.1);
      color: var(--color-secondary);
    }

    &:disabled {
      opacity: 0.5;
      cursor: not-allowed;

      &:hover {
        background: none;
        color: var(--color-text-light);
      }
    }

    &:focus {
      outline: none;
      background: rgba(135, 206, 235, 0.1);
    }
  }

  .chat-send:not(:disabled):hover {
    background: var(--color-secondary);
    color: var(--color-text-inverse);
    @include glow(var(--glow-size-small, var(--color-secondary), 0.4);
  }

  /* Êñá‰ª∂‰∏ä‰º†Âå∫Âüü */
  .chat-upload-area {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
  }

  .upload-dropzone {
    background: var(--color-bg-primary);
    border: 2px dashed var(--color-secondary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-8);
    text-align: center;
    max-width: 300px;
  }

  .upload-icon {
    color: var(--color-secondary);
    margin-bottom: var(--spacing-4);
    opacity: 0.7;
  }

  .upload-text {
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-4);
    font-weight: var(--font-weight-medium);
  }

  .upload-button {
    padding: var(--spacing-2) var(--spacing-4);
    background: var(--color-secondary);
    color: var(--color-text-inverse);
    border: none;
    border-radius: var(--radius-base);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    margin-right: var(--spacing-2);
    transition: all var(--duration-fast) var(--ease-out);

    &:hover {
      transform: translateY(-1px);
      @include glow(var(--glow-size-small, var(--color-secondary), 0.4);
    }
  }

  .upload-cancel {
    padding: var(--spacing-2) var(--spacing-4);
    background: transparent;
    color: var(--color-text-light);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);

    &:hover {
      background: var(--color-bg-tertiary);
      color: var(--color-text-primary);
    }
  }

  /* Á¶ªÁ∫øË°®Âçï */
  .chat-offline-form {
    position: absolute;
    inset: 0;
    background: var(--color-bg-primary);
    padding: var(--spacing-6);
    overflow-y: auto;
  }

  .offline-form__header {
    text-align: center;
    margin-bottom: var(--spacing-6);
  }

  .offline-form__title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-2);
  }

  .offline-form__description {
    color: var(--color-text-light);
    line-height: 1.4;
  }

  .form-group {
    margin-bottom: var(--spacing-4);
  }

  .form-label {
    display: block;
    margin-bottom: var(--spacing-2);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
  }

  .form-input,
  .form-select,
  .form-textarea {
    width: 100%;
    padding: var(--spacing-3);
    background: var(--color-bg-primary);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-base);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
    transition: all var(--duration-normal) var(--ease-out);

    &:focus {
      outline: none;
      border-color: var(--color-secondary);
      @include glow(var(--glow-size-small, var(--color-secondary), 0.3);
    }

    &::placeholder {
      color: var(--color-text-light);
      opacity: 0.7;
    }
  }

  .form-textarea {
    resize: vertical;
    min-height: 100px;
    line-height: 1.5;
  }

  .form-actions {
    display: flex;
    gap: var(--spacing-3);
    justify-content: flex-end;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-2);
    padding: var(--spacing-3) var(--spacing-4);
    border-radius: var(--radius-base);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-out);
    border: 2px solid transparent;

    &:focus {
      outline: none;
    }

    &--primary {
      background: var(--color-secondary);
      color: var(--color-text-inverse);
      border-color: var(--color-secondary);
      @include glow(var(--glow-size-small, var(--color-secondary), 0.4);

      &:hover {
        transform: translateY(-1px);
        @include glow(var(--glow-size-medium, var(--color-secondary), 0.6);
      }
    }

    &--secondary {
      background: transparent;
      color: var(--color-text-primary);
      border-color: var(--color-border);

      &:hover {
        background: var(--color-bg-tertiary);
        border-color: var(--color-secondary);
        color: var(--color-secondary);
      }
    }
  }

  /* ÂìçÂ∫îÂºèËÆæËÆ° */
  @include mobile-only {
    .chat-window {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      border-radius: 0;
      bottom: 0;
      right: 0;
    }

    .chat-window[data-position="bottom-left"],
    .chat-window[data-position="bottom-right"],
    .chat-window[data-position="top-left"],
    .chat-window[data-position="top-right"] {
      inset: 0;
    }

    .chat-message {
      max-width: 90%;
    }

    .form-actions {
      flex-direction: column;
    }

    .chat-welcome__quick-actions {
      flex-direction: column;
    }

    .quick-action {
      text-align: center;
    }
  }

  @include respond-to('md') {
    .chat-window {
      min-height: 500px;
    }
  }

  // È´òÂØπÊØîÂ∫¶Ê®°ÂºèÊîØÊåÅ
  @media (prefers-contrast: high) {
    .chat-toggle {
      border: 3px solid var(--color-text-inverse);
    }

    .chat-window {
      border-width: 3px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      border-width: 3px;
    }

    .btn {
      border-width: 3px;
      font-weight: var(--font-weight-bold);
    }
  }

  // ÂáèÂ∞ëÂä®ÁîªÂÅèÂ•ΩÊîØÊåÅ
  @media (prefers-reduced-motion: reduce) {
    .chat-toggle:hover,
    .chat-header__action:hover,
    .quick-action:hover,
    .btn:hover {
      transform: none;
    }

    .chat-message {
      animation: none;
    }

    .typing-dot {
      animation: none;
    }

    .chat-toggle__pulse,
    .chat-toggle__badge {
      animation: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    class CustomerSupportChat {
      constructor(element) {
        this.element = element;
        this.toggleBtn = element.querySelector('[data-chat-toggle]');
        this.window = element.querySelector('[data-chat-window]');
        this.messagesContainer = element.querySelector('[data-chat-messages]');
        this.input = element.querySelector('[data-chat-input]');
        this.sendBtn = element.querySelector('[data-chat-send]');
        this.typingIndicator = element.querySelector('[data-chat-typing]');
        this.statusIndicator = element.querySelector('[data-chat-status]');
        this.badge = element.querySelector('[data-chat-badge]');
        this.offlineForm = element.querySelector('[data-chat-offline-form]');
        this.notificationSound = document.getElementById('chat-notification-sound');

        this.isOpen = false;
        this.isOnline = this.checkOnlineStatus();
        this.messageHistory = [];
        this.currentAgent = null;

        this.init();
      }

      init() {
        this.bindEvents();
        this.updateStatus();
        this.loadMessageHistory();
        this.checkUnreadMessages();

        // ÂàùÂßãÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
        if (!this.messageHistory.length) {
          this.showWelcomeMessage();
        }
      }

      bindEvents() {
        // ËÅäÂ§©Á™óÂè£ÂàáÊç¢
        this.toggleBtn.addEventListener('click', () => this.toggleChat());

        // ÂèëÈÄÅÊ∂àÊÅØ
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        this.input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });

        // Ëá™Âä®Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
        this.input.addEventListener('input', () => {
          this.input.style.height = 'auto';
          this.input.style.height = this.input.scrollHeight + 'px';
          this.updateSendButton();
        });

        // Âø´ÈÄüÊìç‰Ωú
        document.querySelectorAll('[data-quick-action]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const action = e.target.dataset.quickAction;
            this.handleQuickAction(action);
          });
        });

        // ÊúÄÂ∞èÂåñÊåâÈíÆ
        document.querySelector('[data-chat-minimize]')?.addEventListener('click', () => {
          this.minimizeChat();
        });

        // ÂºπÂá∫Á™óÂè£
        document.querySelector('[data-chat-popout]')?.addEventListener('click', () => {
          this.popoutChat();
        });

        // Á¶ªÁ∫øË°®Âçï
        const offlineForm = this.element.querySelector('[data-offline-form]');
        if (offlineForm) {
          offlineForm.addEventListener('submit', (e) => this.handleOfflineMessage(e));
        }

        // Êñá‰ª∂‰∏ä‰º†
        this.setupFileUpload();

        // Ë°®ÊÉÖÈÄâÊã©
        document.querySelector('[data-chat-emoji]')?.addEventListener('click', () => {
          this.showEmojiPicker();
        });

        // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden && this.isOpen) {
            this.markMessagesAsRead();
          }
        });

        // ÂÆöÊúüÊ£ÄÊü•Âú®Á∫øÁä∂ÊÄÅ
        setInterval(() => {
          this.updateStatus();
        }, 30000);
      }

      toggleChat() {
        if (this.isOpen) {
          this.closeChat();
        } else {
          this.openChat();
        }
      }

      openChat() {
        this.isOpen = true;
        this.window.classList.remove('hidden');
        setTimeout(() => {
          this.window.classList.add('visible');
        }, 10);
        this.toggleBtn.setAttribute('aria-expanded', 'true');
        this.markMessagesAsRead();
        this.focusInput();
      }

      closeChat() {
        this.isOpen = false;
        this.window.classList.remove('visible');
        setTimeout(() => {
          this.window.classList.add('hidden');
        }, 300);
        this.toggleBtn.setAttribute('aria-expanded', 'false');
      }

      minimizeChat() {
        this.window.classList.remove('visible');
        setTimeout(() => {
          this.window.classList.add('hidden');
        }, 300);
      }

      popoutChat() {
        const chatUrl = `${window.location.origin}/chat`;
        window.open(chatUrl, 'chat', 'width=400,height=600,scrollbars=yes,resizable=yes');
        this.closeChat();
      }

      sendMessage() {
        const message = this.input.value.trim();
        if (!message) return;

        this.addMessage(message, 'sent');
        this.input.value = '';
        this.input.style.height = 'auto';
        this.updateSendButton();

        // Ê®°ÊãüÂèëÈÄÅÂà∞ÊúçÂä°Âô®
        this.sendToServer(message);

        // Â¶ÇÊûúÂú®Á∫øÔºåÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•
        if (this.isOnline) {
          this.showTypingIndicator();
        }
      }

      addMessage(content, type = 'received', sender = null, timestamp = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message message--${type}`;

        const messageId = Date.now() + Math.random();
        messageDiv.dataset.messageId = messageId;

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = type === 'sent' ? 'U' : 'S';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = content;

        const time = document.createElement('div');
        time.className = 'message-time';
        time.textContent = this.formatTime(timestamp || new Date());

        messageContent.appendChild(bubble);
        messageContent.appendChild(time);

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();

        // ‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
        this.messageHistory.push({
          id: messageId,
          content,
          type,
          sender,
          timestamp: timestamp || new Date()
        });

        this.saveMessageHistory();

        // Â¶ÇÊûú‰∏çÊòØÂΩìÂâçÁî®Êà∑ÂèëÈÄÅÁöÑÔºåÊòæÁ§∫ÈÄöÁü•
        if (type === 'received' && !document.hasFocus()) {
          this.showNotification();
        }
      }

      sendToServer(message) {
        // Ê®°ÊãüAPIË∞ÉÁî®
        fetch('/api/chat/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message,
            sessionId: this.getSessionId(),
            customerInfo: this.getCustomerInfo()
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Ê®°ÊãüÂÆ¢ÊúçÂõûÂ§ç
            setTimeout(() => {
              this.simulateAgentReply(message);
            }, 1000 + Math.random() * 2000);
          }
        })
        .catch(error => {
          console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
          this.addMessage('{{ 'customer_support.message_failed' | t }}', 'received');
        });
      }

      simulateAgentReply(userMessage) {
        const replies = [
          '{{ 'customer_support.default_reply_1' | t }}',
          '{{ 'customer_support.default_reply_2' | t }}',
          '{{ 'customer_support.default_reply_3' | t }}',
          '{{ 'customer_support.default_reply_4' | t }}'
        ];

        const reply = replies[Math.floor(Math.random() * replies.length)];
        this.hideTypingIndicator();
        this.addMessage(reply, 'received', 'Agent');
      }

      showTypingIndicator() {
        this.typingIndicator.removeAttribute('hidden');
        this.scrollToBottom();
      }

      hideTypingIndicator() {
        this.typingIndicator.setAttribute('hidden', '');
      }

      handleQuickAction(action) {
        const messages = {
          order: '{{ 'customer_support.track_order_message' | t }}',
          return: '{{ 'customer_support.return_policy_message' | t }}',
          shipping: '{{ 'customer_support.shipping_info_message' | t }}'
        };

        const message = messages[action] || '{{ 'customer_support.default_message' | t }}';
        this.input.value = message;
        this.input.focus();
        this.updateSendButton();
      }

      handleOfflineMessage(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        // ÂèëÈÄÅÁ¶ªÁ∫øÊ∂àÊÅØ
        fetch('/api/chat/offline-message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            this.addMessage('{{ 'customer_support.message_sent' | t }}', 'received');
            this.offlineForm.setAttribute('hidden', '');
            e.target.reset();
          } else {
            alert('{{ 'customer_support.send_failed' | t }}');
          }
        })
        .catch(error => {
          console.error('ÂèëÈÄÅÁ¶ªÁ∫øÊ∂àÊÅØÂ§±Ë¥•:', error);
          alert('{{ 'customer_support.send_failed' | t }}');
        });
      }

      updateStatus() {
        this.isOnline = this.checkOnlineStatus();
        const statusText = this.statusIndicator.querySelector('.status-text');
        const statusDot = this.statusIndicator.querySelector('.status-indicator');

        if (this.isOnline) {
          statusText.textContent = '{{ 'customer_support.online' | t }}';
          statusDot.className = 'status-indicator status-indicator--online';
        } else {
          statusText.textContent = '{{ 'customer_support.offline' | t }}';
          statusDot.className = 'status-indicator status-indicator--offline';
        }
      }

      checkOnlineStatus() {
        // Ê®°ÊãüÊ£ÄÊü•Âú®Á∫øÁä∂ÊÄÅ
        const now = new Date();
        const hour = now.getHours();
        const day = now.getDay();

        // Â∑•‰ΩúÊó∂Èó¥ÔºöÂë®‰∏ÄÂà∞Âë®‰∫îÔºå9:00-18:00
        if (day >= 1 && day <= 5 && hour >= 9 && hour < 18) {
          return Math.random() > 0.1; // 90% Ê¶ÇÁéáÂú®Á∫ø
        }

        return Math.random() > 0.8; // ÈùûÂ∑•‰ΩúÊó∂Èó¥ 20% Ê¶ÇÁéáÂú®Á∫ø
      }

      updateSendButton() {
        const hasContent = this.input.value.trim().length > 0;
        this.sendBtn.disabled = !hasContent;
      }

      showNotification() {
        if (this.badge) {
          this.badge.removeAttribute('hidden');
          const badgeText = this.badge.querySelector('.chat-toggle__badge-text');
          const unreadCount = this.getUnreadCount();
          badgeText.textContent = unreadCount > 9 ? '9+' : unreadCount;
        }

        if (this.notificationSound && !document.hidden) {
          this.notificationSound.play().catch(e => {
            // ÈùôÈªòÂ§ÑÁêÜÈü≥È¢ëÊí≠ÊîæÈîôËØØ
          });
        }
      }

      showWelcomeMessage() {
        const welcomeMessage = document.querySelector('[data-chat-welcome]');
        if (welcomeMessage) {
          welcomeMessage.style.display = 'flex';
          setTimeout(() => {
            welcomeMessage.style.display = 'none';
          }, 10000);
        }
      }

      focusInput() {
        setTimeout(() => {
          this.input.focus();
        }, 300);
      }

      scrollToBottom() {
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
      }

      getSessionId() {
        let sessionId = sessionStorage.getItem('chatSessionId');
        if (!sessionId) {
          sessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          sessionStorage.setItem('chatSessionId', sessionId);
        }
        return sessionId;
      }

      getCustomerInfo() {
        return {
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: new Date().toISOString()
        };
      }

      saveMessageHistory() {
        try {
          localStorage.setItem('chatHistory', JSON.stringify(this.messageHistory));
        } catch (e) {
          // ÈùôÈªòÂ§ÑÁêÜÂ≠òÂÇ®ÈîôËØØ
        }
      }

      loadMessageHistory() {
        try {
          const saved = localStorage.getItem('chatHistory');
          if (saved) {
            this.messageHistory = JSON.parse(saved);
            this.displayMessageHistory();
          }
        } catch (e) {
          // ÈùôÈªòÂ§ÑÁêÜÂä†ËΩΩÈîôËØØ
        }
      }

      displayMessageHistory() {
        this.messageHistory.slice(-10).forEach(msg => {
          const messageDiv = document.createElement('div');
          messageDiv.className = `chat-message message--${msg.type}`;
          messageDiv.dataset.messageId = msg.id;

          const avatar = document.createElement('div');
          avatar.className = 'message-avatar';
          avatar.textContent = msg.type === 'sent' ? 'U' : 'S';

          const messageContent = document.createElement('div');
          messageContent.className = 'message-content';

          const bubble = document.createElement('div');
          bubble.className = 'message-bubble';
          bubble.textContent = msg.content;

          const time = document.createElement('div');
          time.className = 'message-time';
          time.textContent = this.formatTime(new Date(msg.timestamp));

          messageContent.appendChild(bubble);
          messageContent.appendChild(time);

          messageDiv.appendChild(avatar);
          messageDiv.appendChild(messageContent);

          this.messagesContainer.appendChild(messageDiv);
        });

        this.scrollToBottom();
      }

      getUnreadCount() {
        // ÁÆÄÂçïÁöÑÊú™ËØªÊ∂àÊÅØËÆ°Êï∞ÈÄªËæë
        return this.messageHistory.filter(msg =>
          msg.type === 'received' && !msg.read
        ).length;
      }

      markMessagesAsRead() {
        this.messageHistory.forEach(msg => {
          if (msg.type === 'received') {
            msg.read = true;
          }
        });
        this.saveMessageHistory();

        if (this.badge) {
          this.badge.setAttribute('hidden', '');
        }
      }

      checkUnreadMessages() {
        const unreadCount = this.getUnreadCount();
        if (unreadCount > 0) {
          this.showNotification();
        }
      }

      formatTime(date) {
        return date.toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      setupFileUpload() {
        const attachmentBtn = this.element.querySelector('[data-chat-attachment]');
        const fileInput = this.element.querySelector('[data-chat-file-input]');
        const uploadArea = this.element.querySelector('[data-chat-upload-area]');
        const uploadCancel = this.element.querySelector('[data-chat-upload-cancel]');

        if (attachmentBtn && fileInput) {
          attachmentBtn.addEventListener('click', () => {
            fileInput.click();
          });

          fileInput.addEventListener('change', (e) => {
            this.handleFileSelect(e.target.files);
          });

          if (uploadCancel) {
            uploadCancel.addEventListener('click', () => {
              uploadArea.setAttribute('hidden', '');
              fileInput.value = '';
            });
          }
        }

        // ÊãñÊãΩ‰∏ä‰º†
        const chatContent = this.element.querySelector('.chat-content');
        if (chatContent) {
          ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            chatContent.addEventListener(eventName, (e) => {
              e.preventDefault();
              e.stopPropagation();
            });
          });

          ['dragenter', 'dragover'].forEach(eventName => {
            chatContent.addEventListener(eventName, () => {
              if (!uploadArea.hasAttribute('hidden')) return;
              uploadArea.removeAttribute('hidden');
            });
          });

          ['dragleave', 'drop'].forEach(eventName => {
            chatContent.addEventListener(eventName, () => {
              if (eventName === 'drop') {
                const files = e.dataTransfer.files;
                this.handleFileSelect(files);
              }
              uploadArea.setAttribute('hidden', '');
            });
          });
        }
      }

      handleFileSelect(files) {
        if (files.length === 0) return;

        Array.from(files).forEach(file => {
          if (file.size > 5 * 1024 * 1024) { // 5MBÈôêÂà∂
            alert('{{ 'customer_support.file_too_large' | t }}');
            return;
          }

          this.addFileMessage(file);
        });

        // ÈöêËóè‰∏ä‰º†Âå∫Âüü
        const uploadArea = this.element.querySelector('[data-chat-upload-area]');
        if (uploadArea) {
          uploadArea.setAttribute('hidden', '');
        }
      }

      addFileMessage(file) {
        const fileMessage = `üìé ${file.name} (${this.formatFileSize(file.size)})`;
        this.addMessage(fileMessage, 'sent');

        // ÂÆûÈôÖÊñá‰ª∂‰∏ä‰º†ÈÄªËæë
        this.uploadFile(file);
      }

      uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/chat/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            this.addMessage('{{ 'customer_support.file_uploaded' | t }}', 'received');
          } else {
            this.addMessage('{{ 'customer_support.upload_failed' | t }}', 'received');
          }
        })
        .catch(error => {
          console.error('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•:', error);
          this.addMessage('{{ 'customer_support.upload_failed' | t }}', 'received');
        });
      }

      formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      showEmojiPicker() {
        // ÁÆÄÂçïÁöÑË°®ÊÉÖÈÄâÊã©Âô®ÂÆûÁé∞
        const emojis = ['üòÄ', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üéâ', 'üî•', '‚ú®', 'üíØ'];
        const emojiHtml = emojis.map(emoji =>
          `<span class="emoji-option" data-emoji="${emoji}">${emoji}</span>`
        ).join('');

        const picker = document.createElement('div');
        picker.className = 'emoji-picker';
        picker.innerHTML = emojiHtml;
        picker.style.cssText = `
          position: absolute;
          bottom: 60px;
          right: 10px;
          background: var(--color-bg-primary);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          padding: var(--spacing-2);
          display: flex;
          gap: var(--spacing-1);
          z-index: 1000;
          @include scifi-card();
        `;

        this.element.appendChild(picker);

        picker.querySelectorAll('.emoji-option').forEach(option => {
          option.style.cssText = `
            cursor: pointer;
            padding: var(--spacing-1);
            border-radius: var(--radius-base);
            transition: background 0.2s;
            font-size: 20px;
          `;

          option.addEventListener('click', () => {
            this.input.value += option.dataset.emoji;
            this.input.focus();
            this.updateSendButton();
            picker.remove();
          });

          option.addEventListener('mouseenter', () => {
            option.style.background = 'var(--color-bg-secondary)';
          });

          option.addEventListener('mouseleave', () => {
            option.style.background = 'transparent';
          });
        });

        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
        setTimeout(() => {
          document.addEventListener('click', function closeEmojiPicker(e) {
            if (!picker.contains(e.target)) {
              picker.remove();
              document.removeEventListener('click', closeEmojiPicker);
            }
          });
        }, 100);
      }
    }

    // ÂàùÂßãÂåñËÅäÂ§©ÁªÑ‰ª∂
    const chatElement = document.querySelector('[data-chat-widget]');
    if (chatElement) {
      new CustomerSupportChat(chatElement);
    }
  });
</script>