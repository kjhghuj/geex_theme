{%- comment -%}
  结账页面模板
  提供完整的结账流程，包括地址、配送、支付等步骤
{%- endcomment -%}

<!DOCTYPE html>
<html class="no-js" lang="{{ request.locale.iso_code }}">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
  <meta name="theme-color" content="{{ settings.color_secondary }}">
  <link rel="canonical" href="{{ canonical_url }}">

  {%- if settings.favicon != blank -%}
    <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
  {%- endif -%}

  {%- unless settings.type_header_font.system? and settings.type_body_font.system? -%}
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
  {%- endunless -%}

  <title>{{ page_title }}</title>

  {% if page_description %}
    <meta name="description" content="{{ page_description | escape }}">
  {% endif %}

  {% render 'meta-tags' %}

  <script src="{{ 'global.js' | asset_url }}" defer="defer"></script>
  {{ content_for_header }}

  {%- liquid
    assign body_font_bold = settings.type_body_font | font_modify: 'weight', 'bold'
    assign body_font_italic = settings.type_body_font | font_modify: 'style', 'italic'
    assign body_font_bold_italic = body_font_bold | font_modify: 'style', 'italic'
  -%}

  {% style %}
    {{ settings.type_body_font | font_face: font_display: 'swap' }}
    {{ body_font_bold | font_face: font_display: 'swap' }}
    {{ body_font_italic | font_face: font_display: 'swap' }}
    {{ body_font_bold_italic | font_face: font_display: 'swap' }}
    {{ settings.type_header_font | font_face: font_display: 'swap' }}

    :root {
      --font-body-family: {{ settings.type_body_font.family }}, {{ settings.type_body_font.fallback_families }};
      --font-body-style: {{ settings.type_body_font.style }};
      --font-body-weight: {{ settings.type_body_font.weight }};
      --font-body-weight-bold: {{ settings.type_body_font.weight | plus: 300 | at_most: 1000 }};

      --font-heading-family: {{ settings.type_header_font.family }}, {{ settings.type_header_font.fallback_families }};
      --font-heading-style: {{ settings.type_header_font.style }};
      --font-heading-weight: {{ settings.type_header_font.weight }};

      --font-body-scale: {{ settings.type_body_scale | divided_by: 100.0 }};
      --font-heading-scale: {{ settings.type_header_scale | divided_by: 100.0 }};

      --gradient-base-background: {% if settings.gradient_background != blank %}{{ settings.gradient_background }}{% else %}{{ settings.colors_background }}{% endif %};
      --gradient-base-accent-1: {% if settings.gradient_accent_1 != blank %}{{ settings.gradient_accent_1 }}{% else %}{{ settings.colors_accent_1 }}{% endif %};
      --gradient-base-accent-2: {% if settings.gradient_accent_2 != blank %}{{ settings.gradient_accent_2 }}{% else %}{{ settings.colors_accent_2 }}{% endif %};

      --media-padding: {{ settings.media_padding }}px;
      --media-border-opacity: {{ settings.media_border_opacity | divided_by: 100.0 }};
      --media-border-width: {{ settings.media_border_width }}px;
      --media-radius: {{ settings.media_radius }}px;
      --media-shadow-opacity: {{ settings.media_shadow_opacity | divided_by: 100.0 }};
      --media-shadow-horizontal-offset: {{ settings.media_shadow_horizontal_offset }}px;
      --media-shadow-vertical-offset: {{ settings.media_shadow_vertical_offset }}px;
      --media-shadow-blur-radius: {{ settings.media_shadow_blur_radius }}px;
      --media-shadow-visible: {% if settings.media_shadow_opacity > 0 %}1{% else %}0{% endif %};

      --page-width: {{ settings.page_width | divided_by: 10 }}rem;
      --page-width-margin: {% if settings.page_width == '1600' %}2{% else %}0{% endif %}rem;

      --product-card-image-padding: {{ settings.card_image_padding | divided_by: 10.0 }}rem;
      --product-card-corner-radius: {{ settings.card_corner_radius | divided_by: 10.0 }}rem;
      --product-card-text-alignment: {{ settings.card_text_alignment }};
      --product-card-border-width: {{ settings.card_border_thickness | divided_by: 10.0 }}rem;
      --product-card-border-opacity: {{ settings.card_border_opacity | divided_by: 100.0 }};
      --product-card-shadow-opacity: {{ settings.card_shadow_opacity | divided_by: 100.0 }};
      --product-card-shadow-visible: {% if settings.card_shadow_opacity > 0 %}1{% else %}0{% endif %};
      --product-card-shadow-horizontal-offset: {{ settings.card_shadow_horizontal_offset | divided_by: 10.0 }}rem;
      --product-card-shadow-vertical-offset: {{ settings.card_shadow_vertical_offset | divided_by: 10.0 }}rem;
      --product-card-shadow-blur-radius: {{ settings.card_shadow_blur_radius | divided_by 10.0 }}rem;

      --collection-card-image-padding: {{ settings.collection_card_image_padding | divided_by: 10.0 }}rem;
      --collection-card-corner-radius: {{ settings.collection_card_corner_radius | divided_by 10.0 }}rem;
      --collection-card-text-alignment: {{ settings.collection_card_text_alignment }};
      --collection-card-border-width: {{ settings.collection_card_border_thickness | divided_by: 10.0 }}rem;
      --collection-card-border-opacity: {{ settings.collection_card_border_opacity | divided_by: 100.0 }};
      --collection-card-shadow-opacity: {{ settings.collection_card_shadow_opacity | divided_by: 100.0 }};
      --collection-card-shadow-visible: {% if settings.collection_card_shadow_opacity > 0 %}1{% else %}0{% endif %};
      --collection-card-shadow-horizontal-offset: {{ settings.collection_card_shadow_horizontal_offset | divided_by: 10.0 }}rem;
      --collection-card-shadow-vertical-offset: {{ settings.collection_card_shadow_vertical_offset | divided_by: 10.0 }}rem;
      --collection-card-shadow-blur-radius: {{ settings.collection_card_shadow_blur_radius | divided_by: 10.0 }}rem;

      --blog-card-image-padding: {{ settings.blog_card_image_padding | divided_by: 10.0 }}rem;
      --blog-card-corner-radius: {{ settings.blog_card_corner_radius | divided_by: 10.0 }}rem;
      --blog-card-text-alignment: {{ settings.blog_card_text_alignment }};
      --blog-card-border-width: {{ settings.blog_card_border_thickness | divided_by: 10.0 }}rem;
      --blog-card-border-opacity: {{ settings.blog_card_border_opacity | divided_by: 100.0 }};
      --blog-card-shadow-opacity: {{ settings.blog_card_shadow_opacity | divided_by: 100.0 }};
      --blog-card-shadow-visible: {% if settings.blog_card_shadow_opacity > 0 %}1{% else %}0{% endif %};
      --blog-card-shadow-horizontal-offset: {{ settings.blog_card_shadow_horizontal_offset | divided_by: 10.0 }}rem;
      --blog-card-shadow-vertical-offset: {{ settings.blog_card_shadow_vertical_offset | divided_by: 10.0 }}rem;
      --blog-card-shadow-blur-radius: {{ settings.blog_card_shadow_blur_radius | divided_by: 10.0 }}rem;

      --badge-corner-radius: {{ settings.badge_corner_radius | divided_by: 10.0 }}rem;

      --popup-border-width: {{ settings.popup_border_thickness | divided_by: 10.0 }}rem;
      --popup-border-opacity: {{ settings.popup_border_opacity | divided_by: 100.0 }};
      --popup-corner-radius: {{ settings.popup_corner_radius | divided_by: 10.0 }}rem;
      --popup-shadow-opacity: {{ settings.popup_shadow_opacity | divided_by: 100.0 }};
      --popup-shadow-horizontal-offset: {{ settings.popup_shadow_horizontal_offset | divided_by: 10.0 }}rem;
      --popup-shadow-vertical-offset: {{ settings.popup_shadow_vertical_offset | divided_by: 10.0 }}rem;
      --popup-shadow-blur-radius: {{ settings.popup_shadow_blur_radius | divided_by: 10.0 }}rem;

      --drawer-border-width: {{ settings.drawer_border_thickness | divided_by: 10.0 }}rem;
      --drawer-border-opacity: {{ settings.drawer_border_opacity | divided_by: 100.0 }};
      --drawer-shadow-opacity: {{ settings.drawer_shadow_opacity | divided_by: 100.0 }};
      --drawer-shadow-horizontal-offset: {{ settings.drawer_shadow_horizontal_offset | divided_by: 10.0 }}rem;
      --drawer-shadow-vertical-offset: {{ settings.drawer_shadow_vertical_offset | divided_by: 10.0 }}rem;
      --drawer-shadow-blur-radius: {{ settings.drawer_shadow_blur_radius | divided_by: 10.0 }}rem;

      --spacing-sections-desktop: {{ settings.spacing_sections }}px;
      --spacing-sections-mobile: {% if settings.spacing_sections < 24 %}{{ settings.spacing_sections }}{% else %}{{ settings.spacing_sections | times: 0.7 | round | at_least: 20 }}{% endif %}px;

      --grid-desktop-vertical-spacing: {{ settings.spacing_grid_vertical }}px;
      --grid-desktop-horizontal-spacing: {{ settings.spacing_grid_horizontal }}px;
      --grid-mobile-vertical-spacing: {{ settings.spacing_grid_vertical | divided_by: 2 }}px;
      --grid-mobile-horizontal-spacing: {{ settings.spacing_grid_horizontal | divided_by: 2 }}px;

      --text-boxes-border-opacity: {{ settings.text_boxes_border_opacity | divided_by: 100.0 }};
      --text-boxes-border-width: {{ settings.text_boxes_border_thickness | divided_by: 10.0 }}rem;
      --text-boxes-radius: {{ settings.text_boxes_radius | divided_by: 10.0 }}rem;
      --text-boxes-shadow-opacity: {{ settings.text_boxes_shadow_opacity | divided_by: 100.0 }};
      --text-boxes-shadow-visible: {% if settings.text_boxes_shadow_opacity > 0 %}1{% else %}0{% endif %};
      --text-boxes-shadow-horizontal-offset: {{ settings.text_boxes_shadow_horizontal_offset | divided_by: 10.0 }}rem;
      --text-boxes-shadow-vertical-offset: {{ settings.text_boxes_shadow_vertical_offset | divided_by 10.0 }}rem;
      --text-boxes-shadow-blur-radius: {{ settings.text_boxes_shadow_blur_radius | divided_by 10.0 }}rem;

      --buttons-radius: {{ settings.buttons_radius | divided_by: 10.0 }}rem;
      --buttons-radius-outset: {% if settings.buttons_radius > 0 %}{{ settings.buttons_radius | plus: settings.buttons_border_thickness | divided_by: 10.0 }}rem{% else %}0{% endif %}rem;
      --buttons-border-width: {{ settings.buttons_border_thickness | divided_by: 10.0 }}rem;
      --buttons-border-opacity: {{ settings.buttons_border_opacity | divided_by: 100.0 }};
      --buttons-shadow-opacity: {{ settings.buttons_shadow_opacity | divided_by:100.0 }};
      --buttons-shadow-visible: {% if settings.buttons_shadow_opacity > 0 %}1{% else %}0{% endif %};
      --buttons-shadow-horizontal-offset: {{ settings.buttons_shadow_horizontal_offset | divided_by: 10.0 }}rem;
      --buttons-shadow-vertical-offset: {{ settings.buttons_shadow_vertical_offset | divided_by: 10.0 }}rem;
      --buttons-shadow-blur-radius: {{ settings.buttons_shadow_blur_radius | divided_by 10.0 }}rem;
      --buttons-border-offset: {% if settings.buttons_radius > 0 or settings.buttons_shadow_opacity > 0 %}0.3{% endif %}rem;

      --inputs-radius: {{ settings.inputs_radius | divided_by: 10.0 }}rem;
      --inputs-border-width: {{ settings.inputs_border_thickness | divided_by: 10.0 }}rem;
      --inputs-border-opacity: {{ settings.inputs_border_opacity | divided_by 100.0 }};
      --inputs-shadow-opacity: {{ settings.inputs_shadow_opacity | divided_by 100.0 }};
      --inputs-shadow-horizontal-offset: {{ settings.inputs_shadow_horizontal_offset | divided_by: 10.0 }}rem;
      --inputs-margin-offset: {% if settings.inputs_shadow_vertical_offset != 0 and settings.inputs_shadow_opacity > 0 %}{{ settings.inputs_shadow_vertical_offset | abs | divided_by: 10.0 }}rem{% endif %}rem;
      --inputs-shadow-vertical-offset: {{ settings.inputs_shadow_vertical_offset | divided_by 10.0 }}rem;
      --inputs-shadow-blur-radius: {{ settings.inputs_shadow_blur_radius | divided_by 10.0 }}rem;
      --inputs-radius-outset: {% if settings.inputs_radius > 0 %}{{ settings.inputs_radius | plus: settings.inputs_border_thickness | divided_by: 10.0 }}rem{% else %}0{% endif %}rem;

      --variant-pills-radius: {{ settings.variant_pills_radius | divided_by: 10.0 }}rem;
      --variant-pills-border-width: {{ settings.variant_pills_border_thickness | divided_by: 10.0 }}rem;
      --variant-pills-border-opacity: {{ settings.variant_pills_border_opacity | divided_by 100.0 }};
      --variant-pills-shadow-opacity: {{ settings.variant_pills_shadow_opacity | divided_by 100.0 }};
      --variant-pills-shadow-horizontal-offset: {{ settings.variant_pills_shadow_horizontal_offset | divided_by: 10.0 }}rem;
      --variant-pills-shadow-vertical-offset: {{ settings.variant_pills_shadow_vertical_offset | divided_by 10.0 }}rem;
      --variant-pills-shadow-blur-radius: {{ settings.variant_pills_shadow_blur_radius | divided_by 10.0 }}rem;

      /* 结账页面特定变量 */
      --checkout-bg-primary: #ffffff;
      --checkout-bg-secondary: #f8f9fa;
      --checkout-bg-tertiary: #ffffff;
      --checkout-text-primary: #2c3e50;
      --checkout-text-secondary: #6c757d;
      --checkout-border: #dee2e6;
      --checkout-border-light: #e9ecef;
      --checkout-primary: var(--color-secondary);
      --checkout-primary-hover: var(--color-primary);
      --checkout-success: #28a745;
      --checkout-warning: #ffc107;
      --checkout-error: #dc3545;
      --checkout-info: #17a2b8;
      --checkout-radius: var(--radius-lg);
      --checkout-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
  {% endstyle %}

  {{ 'checkout.css' | asset_url | stylesheet_tag }}

  <script>document.documentElement.className = document.documentElement.className.replace('no-js', 'js');</script>
</head>

<body>
  <a class="skip-to-content-link button visually-hidden" href="#main">
    {{ 'accessibility.skip_to_text' | t }}
  </a>

  {% section 'checkout-header' %}

  <main class="main" id="main" role="main">
    {{ content_for_layout }}
  </main>

  {% section 'checkout-footer' %}

  <!-- 结账页面特定脚本 -->
  {{ 'checkout.js' | asset_url | script }}
  <script>
    // 结账页面初始化
    Shopify.Checkout.step = 'contact_information';

    // 表单验证增强
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.querySelector('form[data-address-form]');
      if (form) {
        enhanceCheckoutForm(form);
      }
    });

    function enhanceCheckoutForm(form) {
      // 添加实时验证
      const inputs = form.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.addEventListener('blur', () => validateField(input));
        input.addEventListener('input', () => clearFieldError(input));
      });

      // 表单提交验证
      form.addEventListener('submit', (e) => {
        if (!validateForm(form)) {
          e.preventDefault();
          scrollToFirstError();
        }
      });

      // 添加自动填充支持
      setupAutoComplete();
    }

    function validateField(field) {
      const isValid = field.checkValidity();
      const errorMessage = getErrorMessage(field);

      if (!isValid) {
        showFieldError(field, errorMessage);
      } else {
        clearFieldError(field);
      }

      return isValid;
    }

    function getErrorMessage(field) {
      if (field.validity.valueMissing) {
        return '此字段是必填的';
      }
      if (field.validity.typeMismatch) {
        return `请输入有效的${field.type === 'email' ? '邮箱地址' : field.type}`;
      }
      if (field.validity.tooShort) {
        return `最少需要${field.minLength}个字符`;
      }
      if (field.validity.tooLong) {
        return `最多只能${field.maxLength}个字符`;
      }
      if (field.validity.patternMismatch) {
        return '格式不正确';
      }
      return '';
    }

    function showFieldError(field, message) {
      clearFieldError(field);
      field.classList.add('error');

      const errorElement = document.createElement('div');
      errorElement.className = 'field-error';
      errorElement.textContent = message;
      errorElement.style.color = 'var(--checkout-error)';
      errorElement.style.fontSize = 'var(--font-size-sm)';
      errorElement.style.marginTop = 'var(--spacing-1)';

      field.parentNode.appendChild(errorElement);
    }

    function clearFieldError(field) {
      field.classList.remove('error');
      const errorElement = field.parentNode.querySelector('.field-error');
      if (errorElement) {
        errorElement.remove();
      }
    }

    function validateForm(form) {
      let isValid = true;
      const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');

      inputs.forEach(input => {
        if (!validateField(input)) {
          isValid = false;
        }
      });

      return isValid;
    }

    function scrollToFirstError() {
      const firstError = document.querySelector('.field-error');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function setupAutoComplete() {
      // 设置自动完成属性
      const emailInput = document.querySelector('input[name="checkout[email]"]');
      if (emailInput) {
        emailInput.autocomplete = 'email';
      }

      const phoneInput = document.querySelector('input[name="checkout[phone]"]');
      if (phoneInput) {
        phoneInput.autocomplete = 'tel';
      }

      const zipInput = document.querySelector('input[name="checkout[shipping_address][zip]"]');
      if (zipInput) {
        zipInput.autocomplete = 'postal-code';
      }

      const nameInputs = document.querySelectorAll('input[name*="[first_name]"], input[name*="[last_name]"]');
      nameInputs.forEach(input => {
        if (input.name.includes('first_name')) {
          input.autocomplete = 'given-name';
        } else if (input.name.includes('last_name')) {
          input.autocomplete = 'family-name';
        }
      });
    }

    // 支付方式增强
    function enhancePaymentMethods() {
      const paymentGateways = document.querySelectorAll('.payment-method');
      paymentGateways.forEach(gateway => {
        gateway.addEventListener('click', () => {
          selectPaymentMethod(gateway);
        });
      });
    }

    function selectPaymentMethod(gateway) {
      // 移除其他选中状态
      paymentGateways.forEach(g => {
        g.classList.remove('selected');
      });

      // 添加选中状态
      gateway.classList.add('selected');

      // 显示对应的支付细节
      const paymentDetails = gateway.querySelector('.payment-details');
      if (paymentDetails) {
        paymentDetails.style.display = 'block';
      }

      // 隐藏其他支付细节
      paymentGateways.forEach(g => {
        if (g !== gateway) {
          const details = g.querySelector('.payment-details');
          if (details) {
            details.style.display = 'none';
          }
        }
      });
    }

    // 初始化支付方式
    enhancePaymentMethods();
  </script>

  <ul hidden>
    <li id="a11y-refresh-page-message">{{ 'accessibility.refresh_page' | t }}</li>
    <li id="a11y-new-window-message">{{ 'accessibility.link_messages.new_window' | t }}</li>
  </ul>
</body>
</html>