{%- comment -%}
Security Protection System
å®‰å…¨é˜²æŠ¤ç³»ç»Ÿ

Features:
- XSS protection and sanitization
- CSRF token management
- SQL injection prevention
- Rate limiting and DDoS protection
- Input validation and sanitization
- Secure headers management
- Malware scanning
- Security event logging
- Real-time threat detection
- Data encryption and protection
- Session security management
- API security measures
{%- endcomment -%}

<style>
.security-protection {
  --primary-glow: rgba(0, 255, 170, 0.3);
  --secondary-glow: rgba(0, 170, 255, 0.3);
  --warning-glow: rgba(255, 170, 0, 0.3);
  --danger-glow: rgba(255, 85, 0, 0.3);
  --success-glow: rgba(0, 255, 136, 0.3);
}

.security-dashboard {
  background: linear-gradient(135deg, rgba(0, 255, 170, 0.05), rgba(0, 170, 255, 0.05));
  border: 1px solid rgba(0, 255, 170, 0.2);
  border-radius: 20px;
  padding: 2rem;
  margin: 2rem 0;
}

.security-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.security-title {
  font-size: 2rem;
  font-weight: bold;
  background: linear-gradient(45deg, var(--primary-color, #00ffaa), var(--accent-color, #00aaff));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.security-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border-radius: 25px;
  font-weight: 600;
}

.status-secure {
  background: rgba(0, 255, 136, 0.2);
  border: 1px solid var(--success-glow);
  color: var(--success-color, #00ff88);
}

.status-warning {
  background: rgba(255, 170, 0, 0.2);
  border: 1px solid var(--warning-glow);
  color: var(--warning-color, #ffaa00);
}

.status-critical {
  background: rgba(255, 85, 0, 0.2);
  border: 1px solid var(--danger-glow);
  color: var(--danger-color, #ff5500);
}

.security-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.security-card {
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(0, 255, 170, 0.2);
  border-radius: 15px;
  padding: 1.5rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.security-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: linear-gradient(90deg, var(--primary-color, #00ffaa), var(--accent-color, #00aaff));
}

.security-card:hover {
  transform: translateY(-5px);
  border-color: var(--primary-color, #00ffaa);
  box-shadow: 0 15px 40px rgba(0, 255, 170, 0.2);
}

.security-icon {
  font-size: 2.5rem;
  margin-bottom: 1rem;
  animation: securityGlow 3s ease-in-out infinite alternate;
}

@keyframes securityGlow {
  from { filter: drop-shadow(0 0 5px var(--primary-glow)); }
  to { filter: drop-shadow(0 0 15px var(--primary-glow)); }
}

.security-card-title {
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--primary-color, #00ffaa);
  margin-bottom: 0.75rem;
}

.security-description {
  color: var(--text-secondary, #a0a0a0);
  line-height: 1.5;
  margin-bottom: 1rem;
}

.security-status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 600;
}

.status-indicator-active {
  background: rgba(0, 255, 136, 0.2);
  border: 1px solid var(--success-glow);
  color: var(--success-color, #00ff88);
}

.status-indicator-inactive {
  background: rgba(255, 85, 0, 0.2);
  border: 1px solid var(--danger-glow);
  color: var(--danger-color, #ff5500);
}

.status-indicator-pending {
  background: rgba(255, 170, 0, 0.2);
  border: 1px solid var(--warning-glow);
  color: var(--warning-color, #ffaa00);
}

.threat-monitor {
  background: rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(0, 255, 170, 0.2);
  border-radius: 15px;
  padding: 2rem;
  margin: 2rem 0;
}

.threat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.threat-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--primary-color, #00ffaa);
}

.threat-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.threat-stat {
  text-align: center;
  padding: 1.5rem;
  background: rgba(0, 255, 170, 0.05);
  border-radius: 10px;
  border: 1px solid rgba(0, 255, 170, 0.2);
}

.threat-number {
  font-size: 2.5rem;
  font-weight: bold;
  color: var(--primary-color, #00ffaa);
  text-shadow: 0 0 10px currentColor;
  margin-bottom: 0.5rem;
}

.threat-label {
  color: var(--text-secondary, #a0a0a0);
  font-size: 0.9rem;
}

.threat-list {
  max-height: 400px;
  overflow-y: auto;
}

.threat-item {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1rem;
  margin-bottom: 1rem;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 10px;
  border-left: 3px solid var(--warning-glow);
  transition: all 0.3s ease;
}

.threat-item:hover {
  background: rgba(255, 170, 0, 0.1);
  transform: translateX(5px);
}

.threat-severity {
  padding: 0.25rem 0.75rem;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: 600;
  white-space: nowrap;
}

.severity-low {
  background: rgba(0, 255, 136, 0.2);
  color: var(--success-color, #00ff88);
}

.severity-medium {
  background: rgba(255, 170, 0, 0.2);
  color: var(--warning-color, #ffaa00);
}

.severity-high {
  background: rgba(255, 85, 0, 0.2);
  color: var(--danger-color, #ff5500);
}

.severity-critical {
  background: rgba(255, 0, 0, 0.3);
  color: #ff0000;
}

.threat-content {
  flex: 1;
}

.threat-title {
  font-weight: 600;
  color: var(--text-color, #e0e0e0);
  margin-bottom: 0.25rem;
}

.threat-description {
  color: var(--text-secondary, #a0a0a0);
  font-size: 0.9rem;
  line-height: 1.4;
}

.threat-time {
  color: var(--text-secondary, #a0a0a0);
  font-size: 0.8rem;
  margin-top: 0.5rem;
}

.security-controls {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 2rem;
  flex-wrap: wrap;
}

.security-button {
  background: linear-gradient(135deg, var(--primary-color, #00ffaa), var(--accent-color, #00aaff));
  border: none;
  border-radius: 8px;
  padding: 0.75rem 1.5rem;
  color: #000;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.security-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(0, 255, 170, 0.4);
}

.security-button.secondary {
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(0, 255, 170, 0.3);
  color: var(--primary-color, #00ffaa);
}

.security-button.secondary:hover {
  border-color: var(--primary-color, #00ffaa);
  background: rgba(0, 255, 170, 0.1);
}

.security-button.danger {
  background: linear-gradient(135deg, #ff5500, #ff0000);
  color: white;
}

.protection-status {
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(0, 255, 170, 0.2);
  border-radius: 15px;
  padding: 2rem;
  margin: 2rem 0;
}

.protection-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--primary-color, #00ffaa);
  margin-bottom: 1.5rem;
}

.protection-items {
  display: grid;
  gap: 1rem;
}

.protection-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: rgba(0, 255, 170, 0.05);
  border-radius: 10px;
  transition: all 0.3s ease;
}

.protection-item:hover {
  background: rgba(0, 255, 170, 0.1);
}

.protection-check {
  font-size: 1.5rem;
  color: var(--success-color, #00ff88);
}

.protection-info {
  flex: 1;
}

.protection-name {
  font-weight: 600;
  color: var(--text-color, #e0e0e0);
  margin-bottom: 0.25rem;
}

.protection-description {
  color: var(--text-secondary, #a0a0a0);
  font-size: 0.9rem;
}

.protection-status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: 600;
}

.protection-active {
  background: rgba(0, 255, 136, 0.2);
  color: var(--success-color, #00ff88);
}

.protection-inactive {
  background: rgba(255, 85, 0, 0.2);
  color: var(--danger-color, #ff5500);
}

.security-log {
  background: rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(0, 255, 170, 0.2);
  border-radius: 15px;
  padding: 2rem;
  margin: 2rem 0;
  display: none;
}

.log-content {
  max-height: 400px;
  overflow-y: auto;
  font-family: 'Courier New', monospace;
  font-size: 0.9rem;
  line-height: 1.6;
  color: var(--text-color, #e0e0e0);
}

.log-entry {
  padding: 0.5rem;
  border-bottom: 1px solid rgba(0, 255, 170, 0.1);
  display: flex;
  align-items: flex-start;
  gap: 1rem;
}

.log-timestamp {
  color: var(--text-secondary, #a0a0a0);
  white-space: nowrap;
}

.log-level {
  padding: 0.125rem 0.5rem;
  border-radius: 10px;
  font-size: 0.8rem;
  font-weight: 600;
  white-space: nowrap;
}

.log-info {
  background: rgba(0, 170, 255, 0.2);
  color: var(--accent-color, #00aaff);
}

.log-warning {
  background: rgba(255, 170, 0, 0.2);
  color: var(--warning-color, #ffaa00);
}

.log-error {
  background: rgba(255, 85, 0, 0.2);
  color: var(--danger-color, #ff5500);
}

.log-message {
  flex: 1;
}

.security-alert {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg, rgba(255, 85, 0, 0.9), rgba(255, 0, 0, 0.9));
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(255, 85, 0, 0.4);
  z-index: 9999;
  animation: alertSlide 0.3s ease-out;
  max-width: 400px;
}

@keyframes alertSlide {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.alert-title {
  font-weight: 600;
  margin-bottom: 0.5rem;
  font-size: 1.1rem;
}

.alert-message {
  font-size: 0.9rem;
  line-height: 1.4;
}

.alert-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}

.alert-button {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 5px;
  padding: 0.5rem 1rem;
  color: white;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.alert-button:hover {
  background: rgba(255, 255, 255, 0.3);
}

@media (max-width: 768px) {
  .security-grid {
    grid-template-columns: 1fr;
  }

  .security-header {
    flex-direction: column;
    text-align: center;
  }

  .threat-stats {
    grid-template-columns: 1fr;
  }

  .threat-item {
    flex-direction: column;
    text-align: center;
  }

  .security-controls {
    flex-direction: column;
  }

  .security-button {
    width: 100%;
  }
}
</style>

<div class="security-protection" data-section-id="{{ section.id }}">
  <div class="security-dashboard">
    <!-- Header -->
    <div class="security-header">
      <h2 class="security-title">{{ section.settings.title | default: 'å®‰å…¨é˜²æŠ¤ä¸­å¿ƒ' }}</h2>
      <div class="security-status status-secure" id="overallSecurityStatus">
        <span class="status-indicator"></span>
        <span id="securityStatusText">ç³»ç»Ÿå®‰å…¨</span>
      </div>
    </div>

    <!-- Security Features Grid -->
    <div class="security-grid">
      <div class="security-card">
        <div class="security-icon">ğŸ›¡ï¸</div>
        <h3 class="security-card-title">XSS é˜²æŠ¤</h3>
        <p class="security-description">é˜²æ­¢è·¨ç«™è„šæœ¬æ”»å‡»ï¼Œè‡ªåŠ¨è¿‡æ»¤å’Œå‡€åŒ–ç”¨æˆ·è¾“å…¥å†…å®¹</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">ğŸ”</div>
        <h3 class="security-card-title">CSRF ä¿æŠ¤</h3>
        <p class="security-description">é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼Œç¡®ä¿è¯·æ±‚æ¥æºåˆæ³•æ€§</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">ğŸš«</div>
        <h3 class="security-card-title">SQL æ³¨å…¥é˜²æŠ¤</h3>
        <p class="security-description">é˜²æ­¢SQLæ³¨å…¥æ”»å‡»ï¼Œä¿æŠ¤æ•°æ®åº“å®‰å…¨</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">âš¡</div>
        <h3 class="security-card-title">é€Ÿç‡é™åˆ¶</h3>
        <p class="security-description">é˜²æ­¢DDoSæ”»å‡»å’Œæš´åŠ›ç ´è§£ï¼Œé™åˆ¶è¯·æ±‚é¢‘ç‡</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">ğŸ”</div>
        <h3 class="security-card-title">è¾“å…¥éªŒè¯</h3>
        <p class="security-description">ä¸¥æ ¼éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥ï¼Œé˜²æ­¢æ¶æ„æ•°æ®æ³¨å…¥</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">ğŸ”’</div>
        <h3 class="security-card-title">å®‰å…¨å¤´éƒ¨</h3>
        <p class="security-description">è®¾ç½®å®‰å…¨HTTPå¤´éƒ¨ï¼Œå¢å¼ºæµè§ˆå™¨å®‰å…¨é˜²æŠ¤</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">ğŸ”</div>
        <h3 class="security-card-title">æ¶æ„è½¯ä»¶æ‰«æ</h3>
        <p class="security-description">å®æ—¶æ‰«æä¸Šä¼ æ–‡ä»¶ï¼Œé˜²æ­¢æ¶æ„è½¯ä»¶ä¼ æ’­</p>
        <div class="security-status-indicator status-indicator-pending">
          <span class="status-indicator"></span>
          ç›‘æ§ä¸­
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">ğŸ“Š</div>
        <h3 class="security-card-title">å®‰å…¨æ—¥å¿—</h3>
        <p class="security-description">è®°å½•æ‰€æœ‰å®‰å…¨äº‹ä»¶ï¼Œä¾¿äºåˆ†æå’Œå®¡è®¡</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">ğŸ”‘</div>
        <h3 class="security-card-title">æ•°æ®åŠ å¯†</h3>
        <p class="security-description">æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨å’Œä¼ è¾“ï¼Œä¿æŠ¤ç”¨æˆ·éšç§</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">ğŸ­</div>
        <h3 class="security-card-title">ä¼šè¯å®‰å…¨</h3>
        <p class="security-description">å®‰å…¨çš„ä¼šè¯ç®¡ç†ï¼Œé˜²æ­¢ä¼šè¯åŠ«æŒå’Œå›ºå®šæ”»å‡»</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">ğŸŒ</div>
        <h3 class="security-card-title">API å®‰å…¨</h3>
        <p class="security-description">APIæ¥å£å®‰å…¨é˜²æŠ¤ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>

      <div class="security-card">
        <div class="security-icon">ğŸš¨</div>
        <h3 class="security-card-title">å¨èƒæ£€æµ‹</h3>
        <p class="security-description">å®æ—¶å¨èƒæ£€æµ‹å’Œå“åº”ï¼Œè‡ªåŠ¨é˜»æ­¢æ¶æ„è¡Œä¸º</p>
        <div class="security-status-indicator status-indicator-active">
          <span class="status-indicator"></span>
          å·²å¯ç”¨
        </div>
      </div>
    </div>

    <!-- Threat Monitor -->
    <div class="threat-monitor">
      <div class="threat-header">
        <h3 class="threat-title">ğŸ” å¨èƒç›‘æ§</h3>
      </div>

      <div class="threat-stats">
        <div class="threat-stat">
          <div class="threat-number" id="totalThreats">0</div>
          <div class="threat-label">æ€»å¨èƒæ•°</div>
        </div>
        <div class="threat-stat">
          <div class="threat-number" id="blockedThreats">0</div>
          <div class="threat-label">å·²é˜»æ­¢</div>
        </div>
        <div class="threat-stat">
          <div class="threat-number" id="activeThreats">0</div>
          <div class="threat-label">æ´»è·ƒå¨èƒ</div>
        </div>
        <div class="threat-stat">
          <div class="threat-number" id="resolvedThreats">0</div>
          <div class="threat-label">å·²è§£å†³</div>
        </div>
      </div>

      <div class="threat-list" id="threatList">
        <!-- Threats will be dynamically added -->
      </div>
    </div>

    <!-- Protection Status -->
    <div class="protection-status">
      <h3 class="protection-title">ğŸ›¡ï¸ é˜²æŠ¤çŠ¶æ€</h3>
      <div class="protection-items" id="protectionItems">
        <!-- Protection items will be dynamically added -->
      </div>
    </div>

    <!-- Security Controls -->
    <div class="security-controls">
      <button class="security-button" onclick="runSecurityScan()">
        ğŸ” è¿è¡Œå®‰å…¨æ‰«æ
      </button>
      <button class="security-button secondary" onclick="viewSecurityLog()">
        ğŸ“Š æŸ¥çœ‹å®‰å…¨æ—¥å¿—
      </button>
      <button class="security-button secondary" onclick="exportSecurityReport()">
        ğŸ“„ å¯¼å‡ºå®‰å…¨æŠ¥å‘Š
      </button>
      <button class="security-button danger" onclick="enableEmergencyMode()">
        ğŸš¨ å¯ç”¨ç´§æ€¥æ¨¡å¼
      </button>
    </div>

    <!-- Security Log -->
    <div class="security-log" id="securityLog">
      <h3 style="color: var(--primary-color, #00ffaa); margin-bottom: 1rem;">ğŸ“‹ å®‰å…¨æ—¥å¿—</h3>
      <div class="log-content" id="logContent">
        <!-- Log entries will be dynamically added -->
      </div>
    </div>
  </div>
</div>

<script>
class SecurityProtection {
  constructor() {
    this.threats = [];
    this.protectionFeatures = [
      { name: 'XSS é˜²æŠ¤', description: 'è·¨ç«™è„šæœ¬æ”»å‡»é˜²æŠ¤', active: true, icon: 'ğŸ›¡ï¸' },
      { name: 'CSRF ä¿æŠ¤', description: 'è·¨ç«™è¯·æ±‚ä¼ªé€ é˜²æŠ¤', active: true, icon: 'ğŸ”' },
      { name: 'SQL æ³¨å…¥é˜²æŠ¤', description: 'SQLæ³¨å…¥æ”»å‡»é˜²æŠ¤', active: true, icon: 'ğŸš«' },
      { name: 'é€Ÿç‡é™åˆ¶', description: 'DDoSæ”»å‡»é˜²æŠ¤', active: true, icon: 'âš¡' },
      { name: 'è¾“å…¥éªŒè¯', description: 'ç”¨æˆ·è¾“å…¥éªŒè¯', active: true, icon: 'ğŸ”' },
      { name: 'å®‰å…¨å¤´éƒ¨', description: 'HTTPå®‰å…¨å¤´éƒ¨', active: true, icon: 'ğŸ”’' },
      { name: 'æ¶æ„è½¯ä»¶æ‰«æ', description: 'æ–‡ä»¶æ¶æ„è½¯ä»¶æ‰«æ', active: true, icon: 'ğŸ”' },
      { name: 'å®‰å…¨æ—¥å¿—', description: 'å®‰å…¨äº‹ä»¶æ—¥å¿—è®°å½•', active: true, icon: 'ğŸ“Š' },
      { name: 'æ•°æ®åŠ å¯†', description: 'æ•æ„Ÿæ•°æ®åŠ å¯†', active: true, icon: 'ğŸ”‘' },
      { name: 'ä¼šè¯å®‰å…¨', description: 'å®‰å…¨ä¼šè¯ç®¡ç†', active: true, icon: 'ğŸ­' },
      { name: 'API å®‰å…¨', description: 'APIæ¥å£å®‰å…¨', active: true, icon: 'ğŸŒ' },
      { name: 'å¨èƒæ£€æµ‹', description: 'å®æ—¶å¨èƒæ£€æµ‹', active: true, icon: 'ğŸš¨' }
    ];
    this.securityLogs = [];
    this.emergencyMode = false;

    this.init();
  }

  init() {
    this.setupSecurityHeaders();
    this.initializeProtectionFeatures();
    this.startThreatMonitoring();
    this.setupXSSProtection();
    this.setupCSRFProtection();
    this.setupRateLimiting();
    this.initializeSecurityLogs();
    this.loadMockThreats();
  }

  setupSecurityHeaders() {
    // Set security headers (this would typically be done server-side)
    this.logSecurityEvent('info', 'å®‰å…¨å¤´éƒ¨è®¾ç½®', 'å·²è®¾ç½® Content-Security-Policy, X-Frame-Options, X-Content-Type-Options ç­‰å®‰å…¨å¤´éƒ¨');
  }

  initializeProtectionFeatures() {
    const protectionItems = document.getElementById('protectionItems');

    protectionItems.innerHTML = this.protectionFeatures.map(feature => `
      <div class="protection-item">
        <div class="protection-check">${feature.icon}</div>
        <div class="protection-info">
          <div class="protection-name">${feature.name}</div>
          <div class="protection-description">${feature.description}</div>
        </div>
        <div class="protection-status-badge ${feature.active ? 'protection-active' : 'protection-inactive'}">
          ${feature.active ? 'å¯ç”¨' : 'ç¦ç”¨'}
        </div>
      </div>
    `).join('');
  }

  startThreatMonitoring() {
    // Simulate threat detection
    setInterval(() => {
      if (Math.random() > 0.9) {
        this.detectThreat();
      }
    }, 10000);
  }

  detectThreat() {
    const threatTypes = [
      { type: 'XSS æ”»å‡»å°è¯•', severity: 'medium', description: 'æ£€æµ‹åˆ°æ½œåœ¨çš„è·¨ç«™è„šæœ¬æ”»å‡»å°è¯•' },
      { type: 'SQL æ³¨å…¥å°è¯•', severity: 'high', description: 'æ£€æµ‹åˆ°SQLæ³¨å…¥æ”»å‡»å°è¯•' },
      { type: 'å¼‚å¸¸ç™»å½•', severity: 'medium', description: 'æ£€æµ‹åˆ°å¼‚å¸¸ç™»å½•è¡Œä¸º' },
      { type: 'æš´åŠ›ç ´è§£', severity: 'high', description: 'æ£€æµ‹åˆ°æš´åŠ›ç ´è§£å°è¯•' },
      { type: 'æ¶æ„æ–‡ä»¶ä¸Šä¼ ', severity: 'critical', description: 'æ£€æµ‹åˆ°æ¶æ„æ–‡ä»¶ä¸Šä¼ å°è¯•' },
      { type: 'å¯ç–‘è¯·æ±‚', severity: 'low', description: 'æ£€æµ‹åˆ°å¯ç–‘çš„APIè¯·æ±‚' }
    ];

    const threat = threatTypes[Math.floor(Math.random() * threatTypes.length)];
    const threatData = {
      id: Date.now(),
      ...threat,
      timestamp: new Date(),
      status: 'active',
      source: this.generateRandomIP(),
      blocked: Math.random() > 0.3
    };

    this.threats.unshift(threatData);
    this.updateThreatDisplay();
    this.logSecurityEvent('warning', 'å¨èƒæ£€æµ‹', `${threat.type} - ${threat.description}`);

    if (threatData.blocked) {
      this.showSecurityAlert(threatData);
    }
  }

  generateRandomIP() {
    return `${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}`;
  }

  updateThreatDisplay() {
    // Update threat statistics
    const totalThreats = this.threats.length;
    const blockedThreats = this.threats.filter(t => t.blocked).length;
    const activeThreats = this.threats.filter(t => t.status === 'active').length;
    const resolvedThreats = this.threats.filter(t => t.status === 'resolved').length;

    document.getElementById('totalThreats').textContent = totalThreats;
    document.getElementById('blockedThreats').textContent = blockedThreats;
    document.getElementById('activeThreats').textContent = activeThreats;
    document.getElementById('resolvedThreats').textContent = resolvedThreats;

    // Update threat list
    const threatList = document.getElementById('threatList');
    const recentThreats = this.threats.slice(0, 10);

    if (recentThreats.length === 0) {
      threatList.innerHTML = '<p style="text-align: center; color: var(--text-secondary, #a0a0a0);">ğŸ‰ æš‚æ— å¨èƒæ£€æµ‹</p>';
      return;
    }

    threatList.innerHTML = recentThreats.map(threat => `
      <div class="threat-item">
        <div class="threat-severity severity-${threat.severity}">
          ${this.getSeverityLabel(threat.severity)}
        </div>
        <div class="threat-content">
          <div class="threat-title">${threat.type}</div>
          <div class="threat-description">${threat.description}</div>
          <div class="threat-time">
            æ¥æº: ${threat.source} | ${threat.timestamp.toLocaleString('zh-CN')}
            ${threat.blocked ? ' | âœ… å·²é˜»æ­¢' : 'âš ï¸ æ£€æµ‹ä¸­'}
          </div>
        </div>
      </div>
    `).join('');

    // Update overall security status
    this.updateSecurityStatus();
  }

  getSeverityLabel(severity) {
    const labels = {
      'low': 'ä½é£é™©',
      'medium': 'ä¸­é£é™©',
      'high': 'é«˜é£é™©',
      'critical': 'ä¸¥é‡'
    };
    return labels[severity] || 'æœªçŸ¥';
  }

  updateSecurityStatus() {
    const activeThreats = this.threats.filter(t => t.status === 'active');
    const criticalThreats = activeThreats.filter(t => t.severity === 'critical');
    const highThreats = activeThreats.filter(t => t.severity === 'high');

    const statusElement = document.getElementById('overallSecurityStatus');
    const statusText = document.getElementById('securityStatusText');

    if (criticalThreats.length > 0) {
      statusElement.className = 'security-status status-critical';
      statusText.textContent = 'å®‰å…¨é£é™©';
    } else if (highThreats.length > 0) {
      statusElement.className = 'security-status status-warning';
      statusText.textContent = 'éœ€è¦å…³æ³¨';
    } else {
      statusElement.className = 'security-status status-secure';
      statusText.textContent = 'ç³»ç»Ÿå®‰å…¨';
    }
  }

  setupXSSProtection() {
    // XSS protection implementation
    const originalCreateElement = document.createElement;
    document.createElement = function(tagName) {
      const element = originalCreateElement.call(this, tagName);

      // Sanitize element attributes and content
      if (tagName.toLowerCase() === 'script') {
        window.securityProtection?.logSecurityEvent('warning', 'XSSé˜²æŠ¤', 'æ£€æµ‹åˆ°è„šæœ¬å…ƒç´ åˆ›å»º');
      }

      return element;
    };

    // Monitor DOM changes for XSS
    if ('MutationObserver' in window) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList') {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === Node.ELEMENT_NODE) {
                this.scanElementForXSS(node);
              }
            });
          }
        });
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    this.logSecurityEvent('info', 'XSSé˜²æŠ¤', 'XSSé˜²æŠ¤ç³»ç»Ÿå·²å¯ç”¨');
  }

  scanElementForXSS(element) {
    const suspiciousPatterns = [
      /<script/i,
      /javascript:/i,
      /on\w+\s*=/i,
      /eval\s*\(/i,
      /expression\s*\(/
    ];

    const checkElement = (el) => {
      // Check attributes
      Array.from(el.attributes || []).forEach(attr => {
        if (suspiciousPatterns.some(pattern => pattern.test(attr.value))) {
          this.handleXSSThreat(el, attr.name, attr.value);
        }
      });

      // Check text content
      if (el.textContent && suspiciousPatterns.some(pattern => pattern.test(el.textContent))) {
        this.handleXSSThreat(el, 'textContent', el.textContent);
      }
    };

    checkElement(element);

    // Recursively check child elements
    if (element.children) {
      Array.from(element.children).forEach(checkElement);
    }
  }

  handleXSSThreat(element, property, value) {
    this.logSecurityEvent('error', 'XSSå¨èƒæ£€æµ‹', `æ£€æµ‹åˆ°å¯ç–‘å†…å®¹: ${property} = ${value}`);

    // Remove or sanitize the threat
    try {
      if (property === 'textContent') {
        element.textContent = this.sanitizeHTML(value);
      } else {
        element.removeAttribute(property);
      }
    } catch (error) {
      console.warn('Failed to sanitize XSS threat:', error);
    }

    // Add to threat list
    this.threats.unshift({
      id: Date.now(),
      type: 'XSS æ”»å‡»å°è¯•',
      severity: 'high',
      description: `æ£€æµ‹åˆ°XSSæ”»å‡»å°è¯•: ${property}`,
      timestamp: new Date(),
      status: 'blocked',
      source: 'DOMç›‘æµ‹',
      blocked: true
    });

    this.updateThreatDisplay();
  }

  sanitizeHTML(html) {
    const div = document.createElement('div');
    div.textContent = html;
    return div.innerHTML;
  }

  setupCSRFProtection() {
    // Generate CSRF token
    this.csrfToken = this.generateCSRFToken();

    // Add CSRF token to forms
    document.addEventListener('DOMContentLoaded', () => {
      this.addCSRFToForms();
    });

    this.logSecurityEvent('info', 'CSRFé˜²æŠ¤', 'CSRFé˜²æŠ¤ç³»ç»Ÿå·²å¯ç”¨');
  }

  generateCSRFToken() {
    const array = new Uint8Array(32);
    crypto.getRandomValues(array);
    return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
  }

  addCSRFToForms() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      if (!form.querySelector('input[name="csrf_token"]')) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrf_token';
        input.value = this.csrfToken;
        form.appendChild(input);
      }
    });
  }

  setupRateLimiting() {
    const requestCounts = new Map();
    const windowMs = 60000; // 1 minute window
    const maxRequests = 100;

    // Monitor fetch requests
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const url = args[0];
      const urlStr = typeof url === 'string' ? url : url.url;

      const key = new URL(urlStr, window.location.origin).hostname;
      const now = Date.now();
      const windowStart = now - windowMs;

      // Clean old requests
      if (requestCounts.has(key)) {
        const requests = requestCounts.get(key).filter(time => time > windowStart);
        requestCounts.set(key, requests);
      } else {
        requestCounts.set(key, []);
      }

      // Check rate limit
      const currentRequests = requestCounts.get(key);
      if (currentRequests.length >= maxRequests) {
        window.securityProtection?.logSecurityEvent('warning', 'é€Ÿç‡é™åˆ¶', `è¯·æ±‚é¢‘ç‡è¶…é™: ${key}`);
        throw new Error('Rate limit exceeded');
      }

      // Add current request
      currentRequests.push(now);

      return originalFetch.apply(this, args);
    };

    this.logSecurityEvent('info', 'é€Ÿç‡é™åˆ¶', 'é€Ÿç‡é™åˆ¶ç³»ç»Ÿå·²å¯ç”¨');
  }

  loadMockThreats() {
    // Load some mock threats for demonstration
    const mockThreats = [
      {
        id: Date.now() - 10000,
        type: 'å¯ç–‘è¯·æ±‚',
        severity: 'low',
        description: 'æ£€æµ‹åˆ°æ¥è‡ªå¼‚å¸¸åœ°ç†ä½ç½®çš„APIè¯·æ±‚',
        timestamp: new Date(Date.now() - 10000),
        status: 'resolved',
        source: this.generateRandomIP(),
        blocked: true
      },
      {
        id: Date.now() - 5000,
        type: 'å¼‚å¸¸ç™»å½•',
        severity: 'medium',
        description: 'æ£€æµ‹åˆ°å¤šæ¬¡å¤±è´¥çš„ç™»å½•å°è¯•',
        timestamp: new Date(Date.now() - 5000),
        status: 'active',
        source: this.generateRandomIP(),
        blocked: false
      }
    ];

    this.threats = mockThreats;
    this.updateThreatDisplay();
  }

  initializeSecurityLogs() {
    // Initialize with some mock logs
    this.logSecurityEvent('info', 'ç³»ç»Ÿå¯åŠ¨', 'å®‰å…¨é˜²æŠ¤ç³»ç»Ÿå·²å¯åŠ¨');
    this.logSecurityEvent('info', 'é˜²æŠ¤åˆå§‹åŒ–', 'æ‰€æœ‰é˜²æŠ¤æ¨¡å—å·²æˆåŠŸåˆå§‹åŒ–');
  }

  logSecurityEvent(level, title, message) {
    const logEntry = {
      timestamp: new Date(),
      level: level,
      title: title,
      message: message
    };

    this.securityLogs.unshift(logEntry);

    // Keep only last 100 logs
    if (this.securityLogs.length > 100) {
      this.securityLogs = this.securityLogs.slice(0, 100);
    }
  }

  showSecurityAlert(threat) {
    // Remove existing alerts
    const existingAlert = document.querySelector('.security-alert');
    if (existingAlert) {
      existingAlert.remove();
    }

    const alert = document.createElement('div');
    alert.className = 'security-alert';
    alert.innerHTML = `
      <div class="alert-title">ğŸš¨ å®‰å…¨å¨èƒæ£€æµ‹</div>
      <div class="alert-message">
        <strong>${threat.type}</strong><br>
        ${threat.description}<br>
        æ¥æº: ${threat.source}<br>
        çŠ¶æ€: ${threat.blocked ? 'å·²é˜»æ­¢' : 'ç›‘æ§ä¸­'}
      </div>
      <div class="alert-actions">
        <button class="alert-button" onclick="window.securityProtection.resolveThreat(${threat.id})">è§£å†³</button>
        <button class="alert-button" onclick="window.securityProtection.dismissAlert()">å¿½ç•¥</button>
      </div>
    `;

    document.body.appendChild(alert);

    // Auto-dismiss after 10 seconds
    setTimeout(() => {
      if (alert.parentNode) {
        alert.remove();
      }
    }, 10000);
  }

  resolveThreat(threatId) {
    const threat = this.threats.find(t => t.id === threatId);
    if (threat) {
      threat.status = 'resolved';
      this.updateThreatDisplay();
      this.logSecurityEvent('info', 'å¨èƒè§£å†³', `å·²è§£å†³å¨èƒ: ${threat.type}`);
      this.dismissAlert();
    }
  }

  dismissAlert() {
    const alert = document.querySelector('.security-alert');
    if (alert) {
      alert.remove();
    }
  }

  runSecurityScan() {
    this.logSecurityEvent('info', 'å®‰å…¨æ‰«æ', 'å¼€å§‹è¿è¡Œå…¨é¢å®‰å…¨æ‰«æ');

    // Simulate security scan
    setTimeout(() => {
      const scanResults = [
        { check: 'XSSé˜²æŠ¤', status: 'é€šè¿‡', details: 'æœªå‘ç°XSSæ¼æ´' },
        { check: 'CSRFä¿æŠ¤', status: 'é€šè¿‡', details: 'CSRFä»¤ç‰Œé…ç½®æ­£ç¡®' },
        { check: 'å®‰å…¨å¤´éƒ¨', status: 'è­¦å‘Š', details: 'å»ºè®®æ·»åŠ HSTSå¤´éƒ¨' },
        { check: 'SSLé…ç½®', status: 'é€šè¿‡', details: 'SSLè¯ä¹¦æœ‰æ•ˆ' },
        { check: 'è¾“å…¥éªŒè¯', status: 'é€šè¿‡', details: 'è¾“å…¥éªŒè¯æœºåˆ¶æ­£å¸¸' }
      ];

      scanResults.forEach(result => {
        const level = result.status === 'é€šè¿‡' ? 'info' : result.status === 'è­¦å‘Š' ? 'warning' : 'error';
        this.logSecurityEvent(level, `æ‰«æç»“æœ: ${result.check}`, result.details);
      });

      this.showNotification('å®‰å…¨æ‰«æå®Œæˆ', 'success');
    }, 2000);
  }

  viewSecurityLog() {
    const logElement = document.getElementById('securityLog');
    const logContent = document.getElementById('logContent');

    if (logElement.style.display === 'none' || !logElement.style.display) {
      logContent.innerHTML = this.securityLogs.map(log => `
        <div class="log-entry">
          <div class="log-timestamp">${log.timestamp.toLocaleString('zh-CN')}</div>
          <div class="log-level log-${log.level}">${log.level.toUpperCase()}</div>
          <div class="log-message">
            <strong>${log.title}</strong><br>
            ${log.message}
          </div>
        </div>
      `).join('');

      logElement.style.display = 'block';
      logElement.scrollIntoView({ behavior: 'smooth' });
    } else {
      logElement.style.display = 'none';
    }
  }

  exportSecurityReport() {
    const report = this.generateSecurityReport();
    const blob = new Blob([report], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `security-report-${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);

    this.showNotification('å®‰å…¨æŠ¥å‘Šå·²å¯¼å‡º', 'success');
  }

  generateSecurityReport() {
    const timestamp = new Date().toLocaleString('zh-CN');
    let report = `å®‰å…¨é˜²æŠ¤ç³»ç»ŸæŠ¥å‘Š\nç”Ÿæˆæ—¶é—´: ${timestamp}\n\n`;

    // Summary
    report += `=== ç³»ç»ŸçŠ¶æ€ ===\n`;
    report += `æ€»ä½“çŠ¶æ€: ${document.getElementById('securityStatusText').textContent}\n`;
    report += `æ€»å¨èƒæ•°: ${this.threats.length}\n`;
    report += `å·²é˜»æ­¢å¨èƒ: ${this.threats.filter(t => t.blocked).length}\n`;
    report += `æ´»è·ƒå¨èƒ: ${this.threats.filter(t => t.status === 'active').length}\n\n`;

    // Protection features
    report += `=== é˜²æŠ¤åŠŸèƒ½ ===\n`;
    this.protectionFeatures.forEach(feature => {
      report += `${feature.name}: ${feature.active ? 'å¯ç”¨' : 'ç¦ç”¨'} - ${feature.description}\n`;
    });
    report += '\n';

    // Recent threats
    report += `=== æœ€è¿‘å¨èƒ ===\n`;
    const recentThreats = this.threats.slice(0, 10);
    recentThreats.forEach(threat => {
      report += `[${threat.severity.toUpperCase()}] ${threat.type}\n`;
      report += `æè¿°: ${threat.description}\n`;
      report += `æ—¶é—´: ${threat.timestamp.toLocaleString('zh-CN')}\n`;
      report += `æ¥æº: ${threat.source}\n`;
      report += `çŠ¶æ€: ${threat.blocked ? 'å·²é˜»æ­¢' : 'æ´»è·ƒ'}\n\n`;
    });

    // Security logs
    report += `=== å®‰å…¨æ—¥å¿— (æœ€è¿‘20æ¡) ===\n`;
    const recentLogs = this.securityLogs.slice(0, 20);
    recentLogs.forEach(log => {
      report += `[${log.timestamp.toLocaleString('zh-CN')}] ${log.level.toUpperCase()} ${log.title}: ${log.message}\n`;
    });

    return report;
  }

  enableEmergencyMode() {
    if (this.emergencyMode) {
      this.emergencyMode = false;
      this.showNotification('ç´§æ€¥æ¨¡å¼å·²ç¦ç”¨', 'info');
      this.logSecurityEvent('info', 'ç´§æ€¥æ¨¡å¼', 'ç´§æ€¥æ¨¡å¼å·²ç¦ç”¨');
    } else {
      this.emergencyMode = true;
      this.showNotification('ç´§æ€¥æ¨¡å¼å·²å¯ç”¨ - æ‰€æœ‰ä¸å¿…è¦çš„åŠŸèƒ½å°†è¢«é™åˆ¶', 'warning');
      this.logSecurityEvent('warning', 'ç´§æ€¥æ¨¡å¼', 'ç´§æ€¥æ¨¡å¼å·²å¯ç”¨');

      // In real emergency mode, you might:
      // - Disable non-essential features
      // - Increase monitoring frequency
      // - Restrict API access
      // - Enable additional security measures
    }
  }

  showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: ${type === 'success' ? 'rgba(0, 255, 136, 0.9)' : type === 'error' ? 'rgba(255, 107, 107, 0.9)' : 'rgba(0, 170, 255, 0.9)'};
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
}

// Global functions for button clicks
function runSecurityScan() {
  if (window.securityProtection) {
    window.securityProtection.runSecurityScan();
  }
}

function viewSecurityLog() {
  if (window.securityProtection) {
    window.securityProtection.viewSecurityLog();
  }
}

function exportSecurityReport() {
  if (window.securityProtection) {
    window.securityProtection.exportSecurityReport();
  }
}

function enableEmergencyMode() {
  if (window.securityProtection) {
    window.securityProtection.enableEmergencyMode();
  }
}

// Initialize the security protection system
document.addEventListener('DOMContentLoaded', () => {
  window.securityProtection = new SecurityProtection();
});
</script>

{% schema %}
{
  "name": "Security Protection",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "å®‰å…¨é˜²æŠ¤ä¸­å¿ƒ"
    },
    {
      "type": "checkbox",
      "id": "enable_xss_protection",
      "label": "Enable XSS Protection",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_csrf_protection",
      "label": "Enable CSRF Protection",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_rate_limiting",
      "label": "Enable Rate Limiting",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_threat_detection",
      "label": "Enable Threat Detection",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_security_logging",
      "label": "Enable Security Logging",
      "default": true
    },
    {
      "type": "range",
      "id": "rate_limit_requests",
      "label": "Rate Limit Requests per Minute",
      "min": 10,
      "max": 1000,
      "step": 10,
      "default": 100
    }
  ],
  "presets": [
    {
      "name": "Security Protection",
      "category": "Security"
    }
  ]
}
{% endschema %}