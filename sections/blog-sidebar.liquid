{% comment %}
  博客侧边栏区块
  包含搜索、分类、标签云、最新文章等组件
{% endcomment %}

<div class="blog-sidebar" data-blog-sidebar>
  <!-- 搜索组件 -->
  <div class="blog-sidebar__section blog-sidebar__search">
    <h3 class="blog-sidebar__title">{{ 'blog.sidebar.search' | t }}</h3>
    <form action="{{ routes.search_url }}" method="get" class="blog-search-form">
      <input type="hidden" name="type" value="article">
      <div class="blog-search-form__wrapper">
        <input type="search"
               name="q"
               placeholder="{{ 'blog.sidebar.search_placeholder' | t }}"
               class="blog-search-form__input"
               value="{{ search.terms | escape }}"
               aria-label="{{ 'blog.sidebar.search' | t }}">
        <button type="submit" class="blog-search-form__button" aria-label="{{ 'general.search.submit' | t }}">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="8" cy="8" r="6"></circle>
            <path d="M13 13l4 4"></path>
          </svg>
        </button>
      </div>
    </form>
  </div>

  <!-- 博客分类 -->
  {% if blogs.size > 1 %}
    <div class="blog-sidebar__section blog-sidebar__blogs">
      <h3 class="blog-sidebar__title">{{ 'blog.sidebar.blogs' | t }}</h3>
      <ul class="blog-sidebar__list">
        {% for blog_item in blogs %}
          <li class="blog-sidebar__list-item">
            <a href="{{ blog_item.url }}"
               class="blog-sidebar__link{% if blog_item.handle == blog.handle %} active{% endif %}">
              {{ blog_item.title }}
              <span class="blog-sidebar__count">({{ blog_item.articles_count }})</span>
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- 标签云 -->
  {% if blog.tags.size > 0 %}
    <div class="blog-sidebar__section blog-sidebar__tags">
      <h3 class="blog-sidebar__title">{{ 'blog.sidebar.popular_tags' | t }}</h3>
      <div class="tag-cloud">
        {% for tag in blog.tags %}
          <a href="{{ blog.url }}/tagged/{{ tag | handle }}"
             class="tag-cloud__tag{% if current_tags contains tag %} active{% endif %}">
            {{ tag }}
            <span class="tag-cloud__count">
              ({{ blog.articles | where: "tags", tag | size }})
            </span>
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- 最新文章 -->
  {% if blog.articles.size > 0 %}
    <div class="blog-sidebar__section blog-sidebar__recent">
      <h3 class="blog-sidebar__title">{{ 'blog.sidebar.recent_posts' | t }}</h3>
      <div class="recent-posts">
        {% for article in blog.articles limit: 5 %}
          <article class="recent-post">
            {% if article.image %}
              <a href="{{ article.url }}" class="recent-post__image-link">
                <img src="{{ article.image | image_url: width: 80, height: 80 }}"
                     alt="{{ article.image.alt | escape }}"
                     loading="lazy"
                     width="80"
                     height="80"
                     class="recent-post__image">
              </a>
            {% endif %}
            <div class="recent-post__content">
              <h4 class="recent-post__title">
                <a href="{{ article.url }}" class="recent-post__link">{{ article.title }}</a>
              </h4>
              <time datetime="{{ article.published_at | date: '%Y-%m-%d' }}"
                    class="recent-post__date">
                {{ article.published_at | date: format: 'date_short' }}
              </time>
            </div>
          </article>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- 归档 -->
  {% if blog.articles.size > 0 %}
    <div class="blog-sidebar__section blog-sidebar__archive">
      <h3 class="blog-sidebar__title">{{ 'blog.sidebar.archive' | t }}</h3>
      <div class="archive-links">
        {% assign current_year = 'now' | date: '%Y' %}
        {% assign all_dates = blog.articles | map: 'published_at' %}
        {% assign years = all_dates | map: 'date' | map: '%Y' | uniq | sort: 'decreasing' %}

        {% for year in years limit: 3 %}
          {% assign year_articles = blog.articles | where: 'published_at', year | size %}
          {% if year_articles > 0 %}
            <div class="archive-year">
              <h4 class="archive-year__title">
                <button type="button"
                        class="archive-year__toggle"
                        data-year-toggle="{{ year }}"
                        aria-expanded="false">
                  {{ year }}
                  <span class="archive-year__count">({{ year_articles }})</span>
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="archive-year__icon">
                    <path d="M4 6h8M4 10h8M6 2l-2 4v6a2 2 0 002 2h4a2 2 0 002-2V6l-2-4H6z"/>
                  </svg>
                </button>
              </h4>
              <ul class="archive-months" data-year-content="{{ year }}" hidden>
                {% assign months = '1,2,3,4,5,6,7,8,9,10,11,12' | split: ',' %}
                {% for month in months reversed %}
                  {% assign month_articles = blog.articles | where: 'published_at', year | where: 'published_at', month | size %}
                  {% if month_articles > 0 %}
                    <li class="archive-month">
                      <a href="{{ blog.url }}/archive/{{ year }}-{{ month }}" class="archive-month__link">
                        {{ month | date: '%B' }}
                        <span class="archive-month__count">({{ month_articles }})</span>
                      </a>
                    </li>
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- RSS订阅 -->
  <div class="blog-sidebar__section blog-sidebar__rss">
    <h3 class="blog-sidebar__title">{{ 'blog.sidebar.subscribe' | t }}</h3>
    <a href="{{ blog.url }}.atom" class="rss-link" target="_blank" rel="noopener noreferrer">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <circle cx="5" cy="15" r="2"/>
        <path d="M2 10c0 1.8.6 3.5 1.7 4.8M2 5c0 3.9 1.6 7.5 4.1 10.1M2 2c5 0 9.5 2 12.7 5.3"/>
      </svg>
      <span>{{ 'blog.sidebar.rss_feed' | t }}</span>
    </a>
  </div>

  <!-- 社交媒体 -->
  {% if settings.social_twitter_link != blank or settings.social_facebook_link != blank or settings.social_instagram_link != blank %}
    <div class="blog-sidebar__section blog-sidebar__social">
      <h3 class="blog-sidebar__title">{{ 'blog.sidebar.follow_us' | t }}</h3>
      <div class="social-links">
        {% if settings.social_twitter_link != blank %}
          <a href="{{ settings.social_twitter_link }}"
             class="social-links__item social-links__item--twitter"
             target="_blank"
             rel="noopener noreferrer"
             aria-label="{{ 'general.social.twitter' | t }}">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M18 4.5c-.7.3-1.5.5-2.3.6.8-.5 1.5-1.3 1.8-2.3-.8.5-1.7.8-2.6 1-.7-.8-1.8-1.3-3-1.3-2.3 0-4.1 1.8-4.1 4.1 0 .3 0 .6.1.9-3.4-.2-6.4-1.8-8.4-4.3-.4.6-.6 1.3-.6 2.1 0 1.4.7 2.7 1.8 3.4-.7 0-1.3-.2-1.9-.5v.1c0 2 1.4 3.6 3.3 4-.3.1-.7.1-1.1.1-.3 0-.5 0-.8-.1.5 1.6 2 2.8 3.8 2.8-1.4 1.1-3.2 1.8-5.1 1.8-.3 0-.7 0-1-.1 1.8 1.2 4 1.8 6.3 1.8 7.5 0 11.6-6 11.6-6 0-.2 0-.3 0-.5.8-.6 1.5-1.3 2.1-2.1z"/>
            </svg>
          </a>
        {% endif %}
        {% if settings.social_facebook_link != blank %}
          <a href="{{ settings.social_facebook_link }}"
             class="social-links__item social-links__item--facebook"
             target="_blank"
             rel="noopener noreferrer"
             aria-label="{{ 'general.social.facebook' | t }}">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M18 2H2C0.9 2 0 2.9 0 4v12c0 1.1 0.9 2 2 2h6v-6H6V9h2V7c0-2 1.2-3 3-3h2v3h-2c-0.6 0-1 0.4-1 1v1h3l-0.5 3H10v6h8c1.1 0 2-0.9 2-2V4c0-1.1-0.9-2-2-2z"/>
            </svg>
          </a>
        {% endif %}
        {% if settings.social_instagram_link != blank %}
          <a href="{{ settings.social_instagram_link }}"
             class="social-links__item social-links__item--instagram"
             target="_blank"
             rel="noopener noreferrer"
             aria-label="{{ 'general.social.instagram' | t }}">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <rect x="2" y="2" width="16" height="16" rx="4" stroke="currentColor" stroke-width="2" fill="none"/>
              <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
              <circle cx="15" cy="5" r="1" stroke="currentColor" stroke-width="2" fill="currentColor"/>
            </svg>
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

<style>
  .blog-sidebar {
    position: sticky;
    top: var(--spacing-6);
  }

  .blog-sidebar__section {
    background: var(--color-bg-primary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-6);
    margin-bottom: var(--spacing-6);
    border: 1px solid var(--color-border);
    @include scifi-card();
  }

  .blog-sidebar__title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-4);
    position: relative;
    padding-left: var(--spacing-4);

    &::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 20px;
      background: linear-gradient(to bottom, var(--color-secondary), var(--color-accent));
      border-radius: var(--radius-full);
      @include glow(var(--glow-size-small, var(--color-secondary), 0.4);
    }
  }

  /* 搜索表单 */
  .blog-search-form__wrapper {
    position: relative;
  }

  .blog-search-form__input {
    width: 100%;
    padding: var(--spacing-3) var(--spacing-4);
    padding-right: var(--spacing-10);
    background: var(--color-bg-secondary);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-full);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
    transition: all var(--duration-normal) var(--ease-out);

    &:focus {
      outline: none;
      border-color: var(--color-secondary);
      @include glow(var(--glow-size-small, var(--color-secondary), 0.3);
    }

    &::placeholder {
      color: var(--color-text-light);
      opacity: 0.7;
    }
  }

  .blog-search-form__button {
    position: absolute;
    right: var(--spacing-2);
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--color-text-light);
    cursor: pointer;
    padding: var(--spacing-2);
    border-radius: var(--radius-full);
    transition: all var(--duration-fast) var(--ease-out);

    &:hover {
      color: var(--color-secondary);
      background: rgba(135, 206, 235, 0.1);
    }

    &:focus {
      outline: none;
      @include glow(var(--glow-size-small, var(--color-secondary), 0.3);
    }
  }

  /* 列表样式 */
  .blog-sidebar__list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .blog-sidebar__list-item {
    margin-bottom: var(--spacing-2);

    &:last-child {
      margin-bottom: 0;
    }
  }

  .blog-sidebar__link {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-2) var(--spacing-3);
    color: var(--color-text-primary);
    text-decoration: none;
    border-radius: var(--radius-base);
    transition: all var(--duration-fast) var(--ease-out);
    font-size: var(--font-size-sm);

    &:hover {
      background: var(--color-bg-secondary);
      color: var(--color-secondary);
      transform: translateX(2px);
    }

    &.active {
      background: var(--color-secondary);
      color: var(--color-text-inverse);
      @include glow(var(--glow-size-small, var(--color-secondary), 0.4);
    }
  }

  .blog-sidebar__count {
    font-size: var(--font-size-xs);
    color: var(--color-text-light);
    background: var(--color-bg-tertiary);
    padding: 0.2em 0.5em;
    border-radius: var(--radius-full);
    font-weight: var(--font-weight-medium);
  }

  .blog-sidebar__link.active .blog-sidebar__count {
    background: rgba(255, 255, 255, 0.2);
    color: inherit;
  }

  /* 标签云 */
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2);
  }

  .tag-cloud__tag {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-1);
    padding: var(--spacing-2) var(--spacing-3);
    background: var(--color-bg-secondary);
    color: var(--color-text-primary);
    text-decoration: none;
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    border: 1px solid var(--color-border);
    transition: all var(--duration-fast) var(--ease-out);

    &:hover {
      background: var(--color-secondary);
      color: var(--color-text-inverse);
      transform: translateY(-1px);
      @include glow(var(--glow-size-small, var(--color-secondary), 0.4);
    }

    &.active {
      background: var(--color-secondary);
      color: var(--color-text-inverse);
      @include glow(var(--glow-size-small, var(--color-secondary), 0.5);
    }
  }

  .tag-cloud__count {
    font-size: 0.7em;
    opacity: 0.7;
  }

  /* 最新文章 */
  .recent-posts {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-4);
  }

  .recent-post {
    display: flex;
    gap: var(--spacing-3);
    padding: var(--spacing-2);
    border-radius: var(--radius-base);
    transition: background var(--duration-fast) var(--ease-out);

    &:hover {
      background: var(--color-bg-secondary);
    }
  }

  .recent-post__image-link {
    flex-shrink: 0;
    width: 80px;
    height: 80px;
    border-radius: var(--radius-base);
    overflow: hidden;
    border: 2px solid var(--color-border);

    &:hover .recent-post__image {
      transform: scale(1.05);
    }
  }

  .recent-post__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-normal) var(--ease-sci-fi);
  }

  .recent-post__content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-width: 0;
  }

  .recent-post__title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    margin: 0 0 var(--spacing-1);
    line-height: 1.4;
  }

  .recent-post__link {
    color: var(--color-text-primary);
    text-decoration: none;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;

    &:hover {
      color: var(--color-secondary);
    }
  }

  .recent-post__date {
    font-size: var(--font-size-xs);
    color: var(--color-text-light);
  }

  /* 归档 */
  .archive-year {
    margin-bottom: var(--spacing-3);

    &:last-child {
      margin-bottom: 0;
    }
  }

  .archive-year__title {
    margin: 0;
  }

  .archive-year__toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: var(--spacing-2) var(--spacing-3);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);

    &:hover {
      background: var(--color-bg-tertiary);
      border-color: var(--color-secondary);
    }

    &:focus {
      outline: none;
      @include glow(var(--glow-size-small, var(--color-secondary), 0.3);
    }

    &[aria-expanded="true"] .archive-year__icon {
      transform: rotate(180deg);
    }
  }

  .archive-year__icon {
    transition: transform var(--duration-fast) var(--ease-out);
  }

  .archive-months {
    list-style: none;
    padding: 0;
    margin: var(--spacing-2) 0 0 var(--spacing-4);
    max-height: 200px;
    overflow-y: auto;
  }

  .archive-month {
    margin-bottom: var(--spacing-1);
  }

  .archive-month__link {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-1) var(--spacing-2);
    color: var(--color-text-primary);
    text-decoration: none;
    border-radius: var(--radius-base);
    font-size: var(--font-size-xs);
    transition: all var(--duration-fast) var(--ease-out);

    &:hover {
      background: var(--color-bg-secondary);
      color: var(--color-secondary);
      transform: translateX(2px);
    }
  }

  .archive-month__count {
    font-size: 0.7em;
    color: var(--color-text-light);
    background: var(--color-bg-tertiary);
    padding: 0.1em 0.4em;
    border-radius: var(--radius-full);
  }

  /* RSS订阅 */
  .rss-link {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-3) var(--spacing-4);
    background: linear-gradient(135deg, #ff6b35, #f7931e);
    color: white;
    text-decoration: none;
    border-radius: var(--radius-base);
    font-weight: var(--font-weight-medium);
    transition: all var(--duration-normal) var(--ease-out);
    @include glow(var(--glow-size-small, #ff6b35, 0.4);

    &:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
      @include glow(var(--glow-size-medium, #ff6b35, 0.6);
    }
  }

  /* 社交媒体 */
  .social-links {
    display: flex;
    gap: var(--spacing-3);
  }

  .social-links__item {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-full);
    color: var(--color-text-light);
    text-decoration: none;
    transition: all var(--duration-normal) var(--ease-out);
    border: 2px solid var(--color-border);

    &:hover {
      transform: translateY(-2px);
      border-color: var(--color-secondary);
    }

    &--twitter:hover {
      color: #1da1f2;
      border-color: #1da1f2;
      @include glow(var(--glow-size-small, #1da1f2, 0.4);
    }

    &--facebook:hover {
      color: #1877f2;
      border-color: #1877f2;
      @include glow(var(--glow-size-small, #1877f2, 0.4);
    }

    &--instagram:hover {
      color: #e4405f;
      border-color: #e4405f;
      @include glow(var(--glow-size-small, #e4405f, 0.4);
    }
  }

  /* 响应式设计 */
  @include mobile-only {
    .blog-sidebar {
      position: static;
      margin-top: var(--spacing-8);
    }

    .blog-sidebar__section {
      padding: var(--spacing-4);
      margin-bottom: var(--spacing-4);
    }

    .recent-post {
      gap: var(--spacing-2);
    }

    .recent-post__image-link {
      width: 60px;
      height: 60px;
    }

    .social-links {
      justify-content: center;
    }
  }

  @include respond-to('md') {
    .blog-sidebar {
      max-width: 280px;
      margin-left: auto;
    }
  }

  // 高对比度模式支持
  @media (prefers-contrast: high) {
    .blog-sidebar__section {
      border-width: 2px;
    }

    .blog-sidebar__title {
      font-weight: var(--font-weight-bold);
    }
  }

  // 减少动画偏好支持
  @media (prefers-reduced-motion: reduce) {
    .archive-year__icon,
    .recent-post__image {
      transition: none;
    }

    .blog-sidebar__link:hover,
    .tag-cloud__tag:hover {
      transform: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 归档年份折叠功能
    const yearToggles = document.querySelectorAll('[data-year-toggle]');

    yearToggles.forEach(toggle => {
      toggle.addEventListener('click', function() {
        const year = this.dataset.yearToggle;
        const content = document.querySelector(`[data-year-content="${year}"]`);
        const isExpanded = this.getAttribute('aria-expanded') === 'true';

        if (content) {
          if (isExpanded) {
            content.setAttribute('hidden', '');
            this.setAttribute('aria-expanded', 'false');
          } else {
            content.removeAttribute('hidden');
            this.setAttribute('aria-expanded', 'true');
          }
        }
      });
    });

    // 搜索框焦点效果
    const searchInput = document.querySelector('.blog-search-form__input');
    if (searchInput) {
      searchInput.addEventListener('focus', function() {
        this.parentElement.classList.add('search-focused');
      });

      searchInput.addEventListener('blur', function() {
        this.parentElement.classList.remove('search-focused');
      });
    }

    // 标签云悬停效果增强
    const tagCloudTags = document.querySelectorAll('.tag-cloud__tag');
    tagCloudTags.forEach(tag => {
      tag.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px) scale(1.05)';
      });

      tag.addEventListener('mouseleave', function() {
        this.style.transform = '';
      });
    });

    // 社交链接点击追踪
    const socialLinks = document.querySelectorAll('.social-links__item');
    socialLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        const platform = this.classList.contains('social-links__item--twitter') ? 'Twitter' :
                        this.classList.contains('social-links__item--facebook') ? 'Facebook' :
                        this.classList.contains('social-links__item--instagram') ? 'Instagram' : 'Unknown';

        // 触发自定义事件
        const socialClickEvent = new CustomEvent('sidebarSocialClick', {
          detail: {
            platform: platform,
            url: this.href
          }
        });
        document.dispatchEvent(socialClickEvent);
      });
    });
  });
</script>

{% schema %}
{
  "name": "博客侧边栏",
  "class": "blog-sidebar-section",
  "settings": [
    {
      "type": "header",
      "content": "搜索设置"
    },
    {
      "type": "checkbox",
      "id": "show_search",
      "label": "显示搜索框",
      "default": true
    },
    {
      "type": "header",
      "content": "博客列表"
    },
    {
      "type": "checkbox",
      "id": "show_blogs",
      "label": "显示其他博客",
      "default": true
    },
    {
      "type": "header",
      "content": "标签设置"
    },
    {
      "type": "checkbox",
      "id": "show_tags",
      "label": "显示标签云",
      "default": true
    },
    {
      "type": "header",
      "content": "最新文章"
    },
    {
      "type": "checkbox",
      "id": "show_recent",
      "label": "显示最新文章",
      "default": true
    },
    {
      "type": "range",
      "id": "recent_posts_count",
      "label": "最新文章数量",
      "min": 3,
      "max": 10,
      "step": 1,
      "default": 5
    },
    {
      "type": "header",
      "content": "归档设置"
    },
    {
      "type": "checkbox",
      "id": "show_archive",
      "label": "显示归档",
      "default": true
    },
    {
      "type": "range",
      "id": "archive_years",
      "label": "归档年数",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 3
    },
    {
      "type": "header",
      "content": "订阅设置"
    },
    {
      "type": "checkbox",
      "id": "show_rss",
      "label": "显示RSS订阅",
      "default": true
    },
    {
      "type": "header",
      "content": "社交媒体"
    },
    {
      "type": "checkbox",
      "id": "show_social",
      "label": "显示社交媒体链接",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "博客侧边栏",
      "category": "博客"
    }
  ]
}
{% endschema %}